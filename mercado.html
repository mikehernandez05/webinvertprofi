<!DOCTYPE html>
<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>InvertProfit â€” Terminal de Trading</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script>
tailwind.config={darkMode:"class",theme:{extend:{colors:{"primary":"#D4AF37","bg-main":"#0b1018","bg-card":"#111827","bg-panel":"#0f1520","bg-hover":"#182030","border-main":"#1c2536","text-w":"#e8edf5","text-m":"#7a8ba5","green":"#00C853","red":"#FF3D00"},fontFamily:{"ui":["Inter","sans-serif"],"mono":["Roboto Mono","monospace"]}}}}
</script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:#0b1018}::-webkit-scrollbar-thumb{background:#1c2536;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#D4AF37}
@keyframes flash-g{0%{background:rgba(0,200,83,.2)}100%{background:transparent}}
@keyframes flash-r{0%{background:rgba(255,61,0,.2)}100%{background:transparent}}
.fl-up{animation:flash-g .6s ease-out}.fl-dn{animation:flash-r .6s ease-out}
@keyframes pdot{0%,100%{opacity:1}50%{opacity:.3}}.live-p{animation:pdot 1s infinite}

/* Market Watch row */
.mw-row{cursor:pointer;transition:background .12s}
.mw-row:hover{background:#182030}
.mw-row.sel{background:rgba(212,175,55,.06);border-left:2px solid #D4AF37}

/* Chart slot */
.chart-slot{position:relative;border:1px solid #1c2536;transition:border-color .15s;overflow:hidden;display:flex;flex-direction:column}
.chart-slot:hover{border-color:#2a3548}
.chart-slot.focused{border-color:rgba(212,175,55,.4);z-index:2}
.chart-slot .slot-close{position:absolute;top:6px;right:6px;z-index:20;opacity:0;transition:opacity .15s}
.chart-slot:hover .slot-close{opacity:1}

/* Bottom tabs */
.chart-tab{cursor:pointer;transition:all .12s;border-bottom:2px solid transparent}
.chart-tab:hover{background:#182030}
.chart-tab.active{border-bottom-color:#D4AF37;background:rgba(212,175,55,.05)}

/* Category tabs */
.cat-btn.act{color:#D4AF37;font-weight:700;background:rgba(212,175,55,.1)}
</style>
</head>
<body class="bg-bg-main text-text-w font-ui h-screen flex flex-col overflow-hidden">

<!-- â•â•â• HEADER â•â•â• -->
<header class="border-b border-border-main bg-bg-panel flex items-center justify-between px-4 py-2 shrink-0 z-50">
    <div class="flex items-center gap-3">
        <img src="images/logo_azul.png" alt="IP" class="h-8" id="logo-img"/>
        <span class="text-lg font-bold text-white" id="logo-text" style="display:none;">InvertProfit</span>
        <script>document.getElementById('logo-img').onerror=function(){this.style.display='none';document.getElementById('logo-text').style.display='inline'};</script>
    </div>
    <nav class="hidden md:flex items-center gap-8">
        <a class="text-text-m hover:text-white transition text-sm" href="index.html">INICIO</a>
        <a class="text-text-m hover:text-white transition text-sm" href="portadanivelesacademia.html">ACADEMIA</a>
        <a class="text-white font-semibold border-b-2 border-primary pb-0.5 text-sm" href="mercado.html">MERCADOS</a>
        <a class="text-text-m hover:text-white transition text-sm" href="#">PORTAFOLIO</a>
    </nav>
    <div class="flex items-center gap-3">
        <div class="flex items-center gap-1.5 mr-2">
            <span id="ws-dot" class="size-2 rounded-full bg-text-m"></span>
            <span id="ws-lbl" class="text-[9px] font-mono text-text-m">Conectando...</span>
        </div>
        <button class="bg-primary text-bg-main font-bold h-9 px-5 rounded-full text-xs tracking-wide hover:bg-primary/90 transition">âš¡ CONECTAR BROKER</button>
        <div class="hidden md:flex items-center gap-2"><span class="text-text-m text-lg">ğŸ””</span><div class="w-8 h-8 bg-gray-600 rounded-full"></div></div>
    </div>
</header>

<!-- â•â•â• MAIN: [Chart Grid CENTER] [Market Watch RIGHT 260px] â•â•â• -->
<div class="flex-1 flex overflow-hidden">

<!-- â•â•â• CENTER: CHART GRID + BOTTOM TABS â•â•â• -->
<div class="flex-1 flex flex-col min-w-0">
    <!-- Chart Grid (2x2) -->
    <div id="chart-grid" class="flex-1 grid grid-cols-2 grid-rows-2 gap-0 min-h-0">
        <!-- Slot 0 -->
        <div class="chart-slot bg-bg-main" id="slot-0" data-idx="0">
            <div class="slot-header flex items-center justify-between px-3 py-1.5 bg-bg-card border-b border-border-main shrink-0">
                <div class="flex items-center gap-2">
                    <div class="slot-icon size-5 rounded-full flex items-center justify-center text-[7px] font-bold bg-gray-700 text-gray-400">â€”</div>
                    <span class="slot-label text-[11px] font-bold text-text-m">VacÃ­o</span>
                    <span class="slot-tf text-[9px] font-mono text-text-m ml-1">H1</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="slot-price text-[11px] font-mono text-text-m">â€”</span>
                    <span class="slot-change text-[9px] font-bold text-text-m">â€”</span>
                </div>
            </div>
            <button class="slot-close size-5 flex items-center justify-center rounded bg-bg-card/90 text-text-m hover:text-red hover:bg-bg-card transition" title="Cerrar"><span class="material-symbols-outlined text-[13px]">close</span></button>
            <div class="slot-chart flex-1 bg-bg-main"></div>
            <div class="slot-empty absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                    <span class="material-symbols-outlined text-[40px] text-border-main">candlestick_chart</span>
                    <p class="text-[10px] text-text-m mt-1">Click en Market Watch<br/>para abrir grÃ¡fico</p>
                </div>
            </div>
        </div>
        <!-- Slot 1 -->
        <div class="chart-slot bg-bg-main" id="slot-1" data-idx="1">
            <div class="slot-header flex items-center justify-between px-3 py-1.5 bg-bg-card border-b border-border-main shrink-0">
                <div class="flex items-center gap-2">
                    <div class="slot-icon size-5 rounded-full flex items-center justify-center text-[7px] font-bold bg-gray-700 text-gray-400">â€”</div>
                    <span class="slot-label text-[11px] font-bold text-text-m">VacÃ­o</span>
                    <span class="slot-tf text-[9px] font-mono text-text-m ml-1">H1</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="slot-price text-[11px] font-mono text-text-m">â€”</span>
                    <span class="slot-change text-[9px] font-bold text-text-m">â€”</span>
                </div>
            </div>
            <button class="slot-close size-5 flex items-center justify-center rounded bg-bg-card/90 text-text-m hover:text-red hover:bg-bg-card transition" title="Cerrar"><span class="material-symbols-outlined text-[13px]">close</span></button>
            <div class="slot-chart flex-1 bg-bg-main"></div>
            <div class="slot-empty absolute inset-0 flex items-center justify-center">
                <div class="text-center"><span class="material-symbols-outlined text-[40px] text-border-main">candlestick_chart</span><p class="text-[10px] text-text-m mt-1">Slot disponible</p></div>
            </div>
        </div>
        <!-- Slot 2 -->
        <div class="chart-slot bg-bg-main" id="slot-2" data-idx="2">
            <div class="slot-header flex items-center justify-between px-3 py-1.5 bg-bg-card border-b border-border-main shrink-0">
                <div class="flex items-center gap-2">
                    <div class="slot-icon size-5 rounded-full flex items-center justify-center text-[7px] font-bold bg-gray-700 text-gray-400">â€”</div>
                    <span class="slot-label text-[11px] font-bold text-text-m">VacÃ­o</span>
                    <span class="slot-tf text-[9px] font-mono text-text-m ml-1">H1</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="slot-price text-[11px] font-mono text-text-m">â€”</span>
                    <span class="slot-change text-[9px] font-bold text-text-m">â€”</span>
                </div>
            </div>
            <button class="slot-close size-5 flex items-center justify-center rounded bg-bg-card/90 text-text-m hover:text-red hover:bg-bg-card transition" title="Cerrar"><span class="material-symbols-outlined text-[13px]">close</span></button>
            <div class="slot-chart flex-1 bg-bg-main"></div>
            <div class="slot-empty absolute inset-0 flex items-center justify-center">
                <div class="text-center"><span class="material-symbols-outlined text-[40px] text-border-main">candlestick_chart</span><p class="text-[10px] text-text-m mt-1">Slot disponible</p></div>
            </div>
        </div>
        <!-- Slot 3 -->
        <div class="chart-slot bg-bg-main" id="slot-3" data-idx="3">
            <div class="slot-header flex items-center justify-between px-3 py-1.5 bg-bg-card border-b border-border-main shrink-0">
                <div class="flex items-center gap-2">
                    <div class="slot-icon size-5 rounded-full flex items-center justify-center text-[7px] font-bold bg-gray-700 text-gray-400">â€”</div>
                    <span class="slot-label text-[11px] font-bold text-text-m">VacÃ­o</span>
                    <span class="slot-tf text-[9px] font-mono text-text-m ml-1">H1</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="slot-price text-[11px] font-mono text-text-m">â€”</span>
                    <span class="slot-change text-[9px] font-bold text-text-m">â€”</span>
                </div>
            </div>
            <button class="slot-close size-5 flex items-center justify-center rounded bg-bg-card/90 text-text-m hover:text-red hover:bg-bg-card transition" title="Cerrar"><span class="material-symbols-outlined text-[13px]">close</span></button>
            <div class="slot-chart flex-1 bg-bg-main"></div>
            <div class="slot-empty absolute inset-0 flex items-center justify-center">
                <div class="text-center"><span class="material-symbols-outlined text-[40px] text-border-main">candlestick_chart</span><p class="text-[10px] text-text-m mt-1">Slot disponible</p></div>
            </div>
        </div>
    </div>
    <!-- Bottom Tabs -->
    <div class="h-[28px] shrink-0 border-t border-border-main bg-bg-card flex items-center overflow-x-auto px-1 gap-0.5" id="bottom-tabs">
        <span class="text-[8px] text-text-m font-mono px-2 opacity-50">GrÃ¡ficos abiertos:</span>
    </div>
</div>

<!-- â•â•â• RIGHT: MARKET WATCH â•â•â• -->
<aside class="w-[260px] shrink-0 border-l border-border-main bg-bg-panel flex flex-col">
    <div class="px-3 py-2 border-b border-border-main flex items-center justify-between bg-bg-card/50">
        <div class="flex items-center gap-1.5">
            <span class="material-symbols-outlined text-primary text-[16px]">monitoring</span>
            <span class="text-[11px] font-bold text-white tracking-wide">Market Watch</span>
        </div>
        <span class="text-[8px] font-mono text-text-m" id="clock">--:--:--</span>
    </div>
    <div class="flex border-b border-border-main shrink-0">
        <button class="cat-btn act flex-1 py-1.5 text-[9px] text-text-m rounded-none transition" data-cat="all">Todo</button>
        <button class="cat-btn flex-1 py-1.5 text-[9px] text-text-m rounded-none transition" data-cat="indices">IDX</button>
        <button class="cat-btn flex-1 py-1.5 text-[9px] text-text-m rounded-none transition" data-cat="forex">FX</button>
        <button class="cat-btn flex-1 py-1.5 text-[9px] text-text-m rounded-none transition" data-cat="commodities">COM</button>
        <button class="cat-btn flex-1 py-1.5 text-[9px] text-text-m rounded-none transition" data-cat="crypto">CRY</button>
    </div>
    <div class="flex items-center px-3 py-1 border-b border-border-main bg-bg-main/50 text-[8px] font-bold text-text-m uppercase tracking-wider">
        <span class="flex-1">SÃ­mbolo</span>
        <span class="w-[72px] text-right">Precio</span>
        <span class="w-[58px] text-right">Cambio</span>
    </div>
    <div class="flex-1 overflow-y-auto" id="mw-list"></div>
</aside>

</div>
<script>
(function(){
'use strict';

/* â”€â”€â”€ CONFIG â”€â”€â”€ */
var API_KEY='Q3I6b14c8HL2l_A7faplgnuMTXekxCUU';
var BASE='https://api.polygon.io';
var WS_URLS={crypto:'wss://socket.polygon.io/crypto',forex:'wss://socket.polygon.io/forex',stocks:'wss://socket.polygon.io/stocks'};

var ASSETS={
    'SPY':       {label:'S&P 500', sub:'SPY',    d:2,ws:'stocks',cat:'indices',color:'#10b981',abbr:'SPX'},
    'QQQ':       {label:'NASDAQ',  sub:'QQQ',    d:2,ws:'stocks',cat:'indices',color:'#6366f1',abbr:'NDQ'},
    'DIA':       {label:'DOW 30',  sub:'DIA',    d:2,ws:'stocks',cat:'indices',color:'#3b82f6',abbr:'DOW'},
    'C:EURUSD':  {label:'EUR/USD', sub:'Euro',   d:5,ws:'forex',cat:'forex',color:'#3b82f6',abbr:'EUR'},
    'C:GBPUSD':  {label:'GBP/USD', sub:'Libra',  d:5,ws:'forex',cat:'forex',color:'#ef4444',abbr:'GBP'},
    'C:USDJPY':  {label:'USD/JPY', sub:'Yen',    d:3,ws:'forex',cat:'forex',color:'#f43f5e',abbr:'JPY'},
    'C:AUDUSD':  {label:'AUD/USD', sub:'AUD',    d:5,ws:'forex',cat:'forex',color:'#22c55e',abbr:'AUD'},
    'C:USDCAD':  {label:'USD/CAD', sub:'CAD',    d:5,ws:'forex',cat:'forex',color:'#dc2626',abbr:'CAD'},
    'C:USDCHF':  {label:'USD/CHF', sub:'CHF',    d:5,ws:'forex',cat:'forex',color:'#ef4444',abbr:'CHF'},
    'C:NZDUSD':  {label:'NZD/USD', sub:'NZD',    d:5,ws:'forex',cat:'forex',color:'#14b8a6',abbr:'NZD'},
    'C:EURGBP':  {label:'EUR/GBP', sub:'E/G',    d:5,ws:'forex',cat:'forex',color:'#8b5cf6',abbr:'E/G'},
    'C:XAUUSD':  {label:'XAU/USD', sub:'Oro',    d:2,ws:'forex',cat:'commodities',color:'#eab308',abbr:'XAU'},
    'C:XAGUSD':  {label:'XAG/USD', sub:'Plata',  d:3,ws:'forex',cat:'commodities',color:'#9ca3af',abbr:'XAG'},
    'X:BTCUSD':  {label:'BTC/USD', sub:'BTC',    d:2,ws:'crypto',cat:'crypto',color:'#f97316',abbr:'BTC'},
    'X:ETHUSD':  {label:'ETH/USD', sub:'ETH',    d:2,ws:'crypto',cat:'crypto',color:'#60a5fa',abbr:'ETH'},
    'X:SOLUSD':  {label:'SOL/USD', sub:'SOL',    d:2,ws:'crypto',cat:'crypto',color:'#818cf8',abbr:'SOL'},
    'X:XRPUSD':  {label:'XRP/USD', sub:'XRP',    d:4,ws:'crypto',cat:'crypto',color:'#94a3b8',abbr:'XRP'},
    'X:ADAUSD':  {label:'ADA/USD', sub:'ADA',    d:4,ws:'crypto',cat:'crypto',color:'#38bdf8',abbr:'ADA'},
    'X:DOGEUSD': {label:'DOGE/USD',sub:'DOGE',   d:5,ws:'crypto',cat:'crypto',color:'#facc15',abbr:'DOGE'},
    'X:AVAXUSD': {label:'AVAX/USD',sub:'AVAX',   d:2,ws:'crypto',cat:'crypto',color:'#ef4444',abbr:'AVAX'},
    'X:LINKUSD': {label:'LINK/USD',sub:'LINK',   d:3,ws:'crypto',cat:'crypto',color:'#2563eb',abbr:'LINK'},
    'X:DOTUSD':  {label:'DOT/USD', sub:'DOT',    d:3,ws:'crypto',cat:'crypto',color:'#ec4899',abbr:'DOT'},
    'X:MATICUSD':{label:'POL/USD', sub:'POL',    d:4,ws:'crypto',cat:'crypto',color:'#a855f7',abbr:'POL'}
};
var TICKERS=Object.keys(ASSETS);

/* â”€â”€â”€ STATE â”€â”€â”€ */
var prices={},prevPrices={},prevCloses={};
var wsConns={},wsAlive={crypto:false,forex:false,stocks:false},wsThrottle={};
// Slots: [{ticker,chart,candleSeries,volumeSeries,emaSeries,candles,tf:{mul,span}}] or null
var slots=[null,null,null,null];
var focusedSlot=0;

var $=function(id){return document.getElementById(id)};
var $$=function(s){return document.querySelectorAll(s)};

/* â”€â”€â”€ UTILS â”€â”€â”€ */
function yyyymmdd(d){return d.toISOString().slice(0,10)}
function ago(n){var d=new Date();d.setDate(d.getDate()-n);return yyyymmdd(d)}
function today(){return yyyymmdd(new Date())}
function fmt(v,t){if(v==null)return'â€”';var dd=ASSETS[t]?ASSETS[t].d:2;return dd>2?v.toFixed(dd):v.toLocaleString('en-US',{minimumFractionDigits:dd,maximumFractionDigits:dd})}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REST â€” /v2/aggs only (Pro plan)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function api(path){
    var sep=path.indexOf('?')>=0?'&':'?';
    try{var r=await fetch(BASE+path+sep+'apiKey='+API_KEY);if(!r.ok)return null;return r.json();}catch(e){return null;}
}
async function getPrice(ticker){
    var d=await api('/v2/aggs/ticker/'+ticker+'/range/1/minute/'+ago(2)+'/'+today()+'?sort=desc&limit=5&adjusted=true');
    if(d&&d.results&&d.results.length){var l=d.results[0],pc=prevCloses[ticker]||l.o;return{price:l.c,change:pc?((l.c-pc)/pc*100):0,ts:l.t};}
    var pv=await api('/v2/aggs/ticker/'+ticker+'/prev?adjusted=true');
    if(pv&&pv.results&&pv.results.length){var r=pv.results[0];return{price:r.c,change:((r.c-r.o)/r.o*100),ts:r.t};}
    return null;
}
async function getCandles(ticker,mul,span){
    var from;
    if(span==='minute') from=mul<=1?ago(2):mul<=5?ago(7):ago(14);
    else if(span==='hour') from=ago(90);
    else if(span==='day') from=ago(365);
    else from=ago(730);
    var d=await api('/v2/aggs/ticker/'+ticker+'/range/'+mul+'/'+span+'/'+from+'/'+today()+'?adjusted=true&sort=asc&limit=5000');
    if(d&&d.results&&d.results.length) return d.results;
    return[];
}
async function loadPrevCloses(){
    await Promise.allSettled(TICKERS.map(function(t){return api('/v2/aggs/ticker/'+t+'/prev?adjusted=true').then(function(d){if(d&&d.results&&d.results.length)prevCloses[t]=d.results[0].c;});}));
}
async function loadAllPrices(){
    var results=await Promise.allSettled(TICKERS.map(function(t){return getPrice(t).then(function(r){return{ticker:t,data:r};});}));
    var ok=0;results.forEach(function(r){if(r.status==='fulfilled'&&r.value&&r.value.data){prices[r.value.ticker]=r.value.data;updateMW(r.value.ticker);ok++;}});return ok;
}
var pollIdx=0;
function pollREST(){var ms=['crypto','forex','stocks'],m=ms[pollIdx%3];pollIdx++;if(wsAlive[m])return;TICKERS.filter(function(t){return ASSETS[t].ws===m;}).forEach(function(t){getPrice(t).then(function(r){if(r){prices[t]=r;updateMW(t);updateSlots(t);}});});}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEBSOCKET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function connectAllWS(){['crypto','forex','stocks'].forEach(connectWS);}
function connectWS(market){
    if(wsConns[market])try{wsConns[market].close();}catch(e){}
    var ws;try{ws=new WebSocket(WS_URLS[market]);}catch(e){return;}wsConns[market]=ws;
    ws.onopen=function(){ws.send(JSON.stringify({action:'auth',params:API_KEY}));};
    ws.onmessage=function(e){var msgs;try{msgs=JSON.parse(e.data);}catch(err){return;}if(!Array.isArray(msgs))msgs=[msgs];msgs.forEach(function(msg){if(msg.ev==='status'&&msg.status==='auth_success'){wsAlive[market]=true;updWS();subMkt(ws,market);return;}if(msg.ev==='status')return;handleWS(msg);});};
    ws.onclose=function(){wsAlive[market]=false;updWS();setTimeout(function(){connectWS(market);},5000);};
    ws.onerror=function(){wsAlive[market]=false;updWS();};
}
function subMkt(ws,m){
    var tks=TICKERS.filter(function(t){return ASSETS[t].ws===m;}),ch;
    if(m==='crypto')ch=tks.map(function(t){return'XT.'+t+',XA.'+t;}).join(',');
    else if(m==='forex')ch=tks.map(function(t){return'C.'+t+',CA.'+t;}).join(',');
    else ch=tks.map(function(t){return'AM.'+t+',T.'+t;}).join(',');
    if(ch)ws.send(JSON.stringify({action:'subscribe',params:ch}));
}
function handleWS(msg){
    var tk=null,p=null;
    if(msg.ev==='XT'){tk=msg.pair;p=msg.p;}else if(msg.ev==='XA'){tk=msg.pair;p=msg.c;}
    else if(msg.ev==='C'){tk=msg.p;p=(msg.a+msg.b)/2;}else if(msg.ev==='CA'){tk=msg.pair;p=msg.c;}
    else if(msg.ev==='AM'){tk=msg.sym;p=msg.c;}else if(msg.ev==='T'){tk=msg.sym;p=msg.p;}
    if(!tk||!p||!ASSETS[tk])return;
    var now=Date.now();if(wsThrottle[tk]&&now-wsThrottle[tk]<300)return;wsThrottle[tk]=now;
    var pc=prevCloses[tk]||(prices[tk]?prices[tk].price:p);
    prices[tk]={price:p,change:pc?((p-pc)/pc*100):0,ts:now};
    updateMW(tk);updateSlots(tk);
}
function updWS(){
    var alive=0;['crypto','forex','stocks'].forEach(function(m){if(wsAlive[m])alive++;});
    var d=$('ws-dot'),l=$('ws-lbl');
    if(alive===3){d.className='size-2 rounded-full bg-green live-p';l.textContent='LIVE Â· WS';l.className='text-[9px] font-mono text-green font-bold';}
    else if(alive>0){d.className='size-2 rounded-full bg-yellow-400 live-p';l.textContent='WS '+alive+'/3';l.className='text-[9px] font-mono text-yellow-400';}
    else{d.className='size-2 rounded-full bg-text-m animate-pulse';l.textContent='REST';l.className='text-[9px] font-mono text-text-m';}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MARKET WATCH (Left Panel)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildMW(){
    var box=$('mw-list');box.innerHTML='';
    TICKERS.forEach(function(tk){
        var a=ASSETS[tk];
        var row=document.createElement('div');
        row.className='mw-row flex items-center px-3 py-[6px] border-b border-border-main/50';
        row.dataset.ticker=tk;row.dataset.cat=a.cat;
        row.innerHTML=
            '<div class="flex items-center gap-1.5 flex-1 min-w-0">'+
                '<div class="size-5 rounded-full flex items-center justify-center text-[7px] font-bold shrink-0" style="background:'+a.color+'20;color:'+a.color+'">'+a.abbr+'</div>'+
                '<span class="text-[11px] font-bold text-white truncate">'+a.label+'</span>'+
            '</div>'+
            '<span class="mw-price w-[72px] text-right text-[10px] font-mono text-text-w">â€”</span>'+
            '<span class="mw-chg w-[58px] text-right text-[9px] font-bold text-text-m">â€”</span>';
        row.addEventListener('click',function(){openChart(tk);});
        box.appendChild(row);
    });
}
function updateMW(tk){
    var d=prices[tk];if(!d)return;
    var row=document.querySelector('.mw-row[data-ticker="'+tk+'"]');if(!row)return;
    var pEl=row.querySelector('.mw-price'),cEl=row.querySelector('.mw-chg');
    if(pEl){
        var nv=fmt(d.price,tk);
        if(pEl.textContent!==nv){
            var old=prevPrices[tk];pEl.textContent=nv;
            if(old!=null&&old!==d.price){row.classList.remove('fl-up','fl-dn');void row.offsetWidth;row.classList.add(d.price>old?'fl-up':'fl-dn');}
            prevPrices[tk]=d.price;
        }
    }
    if(cEl){var pos=d.change>=0;cEl.textContent=(pos?'+':'')+d.change.toFixed(2)+'%';cEl.className='mw-chg w-[58px] text-right text-[9px] font-bold '+(pos?'text-green':'text-red');}
}
function filterMW(cat){
    $$('.cat-btn').forEach(function(b){b.className='cat-btn flex-1 py-1.5 text-[9px] text-text-m rounded-none transition'+(b.dataset.cat===cat?' act':'');});
    $$('.mw-row').forEach(function(r){r.style.display=(cat==='all'||r.dataset.cat===cat)?'':'none';});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHART SLOTS (2x2 Grid)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function createLWChart(container){
    return LightweightCharts.createChart(container,{
        width:container.clientWidth,height:container.clientHeight,
        layout:{background:{type:'solid',color:'#0b1018'},textColor:'#7a8ba5',fontFamily:'Roboto Mono, monospace',fontSize:9},
        grid:{vertLines:{color:'rgba(42,54,77,0.10)'},horzLines:{color:'rgba(42,54,77,0.10)'}},
        crosshair:{mode:LightweightCharts.CrosshairMode.Normal,vertLine:{color:'rgba(212,175,55,0.25)',width:1,style:2,labelBackgroundColor:'#D4AF37'},horzLine:{color:'rgba(212,175,55,0.25)',width:1,style:2,labelBackgroundColor:'#D4AF37'}},
        rightPriceScale:{borderColor:'#1c2536',scaleMargins:{top:0.18,bottom:0.20},minimumWidth:55},
        timeScale:{borderColor:'#1c2536',timeVisible:true,secondsVisible:false,rightOffset:4,barSpacing:3,minBarSpacing:1},
        handleScroll:{vertTouchDrag:false}
    });
}

async function openChart(ticker){
    // Check if already open
    for(var i=0;i<4;i++){if(slots[i]&&slots[i].ticker===ticker){focusSlot(i);return;}}
    // Find empty slot
    var idx=-1;
    for(var i=0;i<4;i++){if(!slots[i]){idx=i;break;}}
    if(idx===-1){
        // Replace focused slot
        idx=focusedSlot;closeSlot(idx);
    }

    var a=ASSETS[ticker];
    var el=$('slot-'+idx);
    var empty=el.querySelector('.slot-empty');if(empty)empty.style.display='none';

    // Update header
    el.querySelector('.slot-icon').style.background=a.color+'25';
    el.querySelector('.slot-icon').style.color=a.color;
    el.querySelector('.slot-icon').textContent=a.abbr;
    el.querySelector('.slot-label').textContent=a.label;
    el.querySelector('.slot-label').className='slot-label text-[11px] font-bold text-white';
    el.querySelector('.slot-tf').textContent='H1';

    // Create chart
    var box=el.querySelector('.slot-chart');
    var lw=createLWChart(box);
    var cs=lw.addCandlestickSeries({upColor:'#00C853',downColor:'#FF3D00',borderUpColor:'#00C853',borderDownColor:'#FF3D00',wickUpColor:'#00C853',wickDownColor:'#FF3D00'});
    var vs=lw.addHistogramSeries({priceFormat:{type:'volume'},priceScaleId:'vol_'+idx});
    lw.priceScale('vol_'+idx).applyOptions({scaleMargins:{top:0.92,bottom:0}});
    var es=lw.addLineSeries({color:'#D4AF37',lineWidth:1,lineStyle:0,priceLineVisible:false,lastValueVisible:false,crosshairMarkerVisible:false});

    new ResizeObserver(function(){lw.applyOptions({width:box.clientWidth,height:box.clientHeight});}).observe(box);

    slots[idx]={ticker:ticker,chart:lw,candleSeries:cs,volumeSeries:vs,emaSeries:es,candles:null,tf:{mul:1,span:'hour'}};
    focusSlot(idx);
    buildTabs();

    // Load candles
    var raw=await getCandles(ticker,1,'hour');
    if(raw.length){
        slots[idx].candles=raw;
        renderSlotCandles(idx,raw);
    }
    if(prices[ticker]) updateSlotHeader(idx);
}

function renderSlotCandles(idx,raw){
    var s=slots[idx];if(!s)return;
    var cd=[],vd=[],seen={};
    for(var i=0;i<raw.length;i++){
        var c=raw[i],t=Math.floor(c.t/1000);if(seen[t])continue;seen[t]=true;
        var rng=c.o?(c.h-c.l)/c.o:0;if(rng>0.05&&i>0)c={t:c.t,o:c.o,h:Math.max(c.o,c.c)*1.002,l:Math.min(c.o,c.c)*0.998,c:c.c,v:c.v};
        cd.push({time:t,open:c.o,high:c.h,low:c.l,close:c.c});
        vd.push({time:t,value:c.v||0,color:c.c>=c.o?'rgba(0,200,83,0.08)':'rgba(255,61,0,0.08)'});
    }
    try{s.candleSeries.setData(cd);s.volumeSeries.setData(vd);s.emaSeries.setData(calcEMA(cd,20));
    if(cd.length>150) s.chart.timeScale().setVisibleLogicalRange({from:cd.length-150,to:cd.length+4});
    else s.chart.timeScale().fitContent();
    s.chart.timeScale().scrollToRealTime();}catch(e){}
}

function closeSlot(idx){
    var s=slots[idx];if(!s)return;
    try{s.chart.remove();}catch(e){}slots[idx]=null;
    var el=$('slot-'+idx);
    el.querySelector('.slot-chart').innerHTML='';
    el.querySelector('.slot-icon').style.background='';el.querySelector('.slot-icon').style.color='';el.querySelector('.slot-icon').textContent='â€”';
    el.querySelector('.slot-label').textContent='VacÃ­o';el.querySelector('.slot-label').className='slot-label text-[11px] font-bold text-text-m';
    el.querySelector('.slot-price').textContent='â€”';el.querySelector('.slot-price').className='slot-price text-[11px] font-mono text-text-m';
    el.querySelector('.slot-change').textContent='â€”';el.querySelector('.slot-change').className='slot-change text-[9px] font-bold text-text-m';
    el.querySelector('.slot-tf').textContent='H1';
    var empty=el.querySelector('.slot-empty');if(empty)empty.style.display='';
    el.classList.remove('focused');
    buildTabs();
}

function focusSlot(idx){
    focusedSlot=idx;
    $$('.chart-slot').forEach(function(el,i){el.classList.toggle('focused',i===idx);});
    $$('.chart-tab').forEach(function(t){t.classList.toggle('active',parseInt(t.dataset.idx)===idx);});
    // Highlight in market watch
    $$('.mw-row').forEach(function(r){r.classList.remove('sel');});
    if(slots[idx]){var row=document.querySelector('.mw-row[data-ticker="'+slots[idx].ticker+'"]');if(row)row.classList.add('sel');}
}

function updateSlotHeader(idx){
    var s=slots[idx];if(!s)return;
    var d=prices[s.ticker];if(!d)return;
    var el=$('slot-'+idx);
    var pEl=el.querySelector('.slot-price'),cEl=el.querySelector('.slot-change');
    var pos=d.change>=0;
    pEl.textContent=fmt(d.price,s.ticker);pEl.className='slot-price text-[11px] font-mono font-medium '+(pos?'text-green':'text-red');
    cEl.textContent=(pos?'+':'')+d.change.toFixed(2)+'%';cEl.className='slot-change text-[9px] font-bold px-1 py-0.5 rounded '+(pos?'text-green bg-green/10':'text-red bg-red/10');
}

function updateSlots(ticker){
    for(var i=0;i<4;i++){
        var s=slots[i];if(!s||s.ticker!==ticker)continue;
        updateSlotHeader(i);
        var d=prices[ticker];if(!d||!s.candles||!s.candles.length)continue;
        var lc=s.candles[s.candles.length-1],np=d.price,tm=Math.floor(lc.t/1000);
        if(lc.o&&Math.abs(np-lc.o)/lc.o<0.03){
            try{s.candleSeries.update({time:tm,open:lc.o,high:Math.max(lc.h,np),low:Math.min(lc.l,np),close:np});
            s.volumeSeries.update({time:tm,value:lc.v||0,color:np>=lc.o?'rgba(0,200,83,0.08)':'rgba(255,61,0,0.08)'});}catch(e){}
        }
    }
}

function calcEMA(d,p){if(d.length<p)return[];var k=2/(p+1),r=[],s=0;for(var i=0;i<p;i++)s+=d[i].close;var pv=s/p;r.push({time:d[p-1].time,value:pv});for(var j=p;j<d.length;j++){var v=d[j].close*k+pv*(1-k);r.push({time:d[j].time,value:v});pv=v;}return r;}

/* â”€â”€â”€ BOTTOM TABS â”€â”€â”€ */
function buildTabs(){
    var box=$('bottom-tabs');
    box.innerHTML='<span class="text-[8px] text-text-m font-mono px-2 opacity-50 shrink-0">GrÃ¡ficos:</span>';
    for(var i=0;i<4;i++){
        var s=slots[i];if(!s)continue;
        var a=ASSETS[s.ticker];
        var tab=document.createElement('div');
        tab.className='chart-tab flex items-center gap-1.5 px-3 py-1 rounded-t'+(i===focusedSlot?' active':'');
        tab.dataset.idx=i;
        tab.innerHTML=
            '<div class="size-4 rounded-full flex items-center justify-center text-[6px] font-bold" style="background:'+a.color+'25;color:'+a.color+'">'+a.abbr+'</div>'+
            '<span class="text-[10px] font-bold text-white">'+a.label+'</span>'+
            '<span class="text-[8px] font-mono text-text-m">,H1</span>'+
            '<button class="tab-x ml-1 text-text-m hover:text-red transition text-[10px] leading-none" title="Cerrar">âœ•</button>';
        tab.addEventListener('click',function(ev){
            if(ev.target.closest('.tab-x')){closeSlot(parseInt(this.dataset.idx));return;}
            focusSlot(parseInt(this.dataset.idx));
        });
        box.appendChild(tab);
    }
}

/* â”€â”€â”€ EVENTS â”€â”€â”€ */
// Category tabs
$$('.cat-btn').forEach(function(b){b.addEventListener('click',function(){filterMW(b.dataset.cat);});});

// Slot close buttons
for(var i=0;i<4;i++){
    (function(idx){
        $('slot-'+idx).querySelector('.slot-close').addEventListener('click',function(e){e.stopPropagation();closeSlot(idx);});
        $('slot-'+idx).addEventListener('click',function(){if(slots[idx])focusSlot(idx);});
    })(i);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init(){
    buildMW();

    // Clock
    setInterval(function(){$('clock').textContent=new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});},1000);

    await loadPrevCloses();
    var ok=await loadAllPrices();

    // Auto-open first 4 charts
    if(ok){
        var defaults=['X:BTCUSD','C:EURUSD','SPY','X:ETHUSD'];
        for(var i=0;i<defaults.length;i++) await openChart(defaults[i]);
        focusSlot(0);
    }

    connectAllWS();
    setInterval(pollREST,8000);

    // Refresh candle data periodically
    setInterval(async function(){
        for(var i=0;i<4;i++){
            var s=slots[i];if(!s)continue;
            var raw=await getCandles(s.ticker,s.tf.mul,s.tf.span);
            if(raw.length){s.candles=raw;renderSlotCandles(i,raw);}
        }
    },45000);
}
document.addEventListener('DOMContentLoaded',init);
})();
</script>
</body></html>