<!DOCTYPE html>
<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>InvertProfit Trading Terminal â€” Mercados</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;500&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#D4AF37",
                    "midnight": "#0a0f1a",
                    "midnight-card": "#111827",
                    "midnight-light": "#1a2538",
                    "midnight-border": "#1f2937",
                    "text-off-white": "#f0f0f0",
                    "text-muted": "#8d9eb5",
                    "chart-green": "#00C853",
                    "chart-red": "#FF3D00",
                },
                fontFamily: {
                    "display": ["Inter", "Manrope", "sans-serif"],
                    "mono": ["Roboto Mono", "monospace"],
                },
            },
        },
    }
</script>
<style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0a0f1a; }
    ::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #D4AF37; }

    @keyframes flash-green { 0%{background-color:rgba(0,200,83,0.3)} 100%{background-color:transparent} }
    @keyframes flash-red { 0%{background-color:rgba(255,61,0,0.3)} 100%{background-color:transparent} }
    .flash-up { animation: flash-green 0.8s ease-out; }
    .flash-down { animation: flash-red 0.8s ease-out; }

    @keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .live-pulse { animation: pulse-dot 1s infinite; }

    @keyframes ticker-slide { 0%{transform:translateY(-100%);opacity:0} 100%{transform:translateY(0);opacity:1} }
    .price-update { animation: ticker-slide 0.25s ease-out; }

    .order-row { transition: all 0.15s ease; cursor: pointer; }
    .order-row:hover { background: rgba(26,37,56,0.7) !important; }
    .order-row.selected { background: rgba(212,175,55,0.06) !important; border-left: 3px solid #D4AF37; }
    .order-row td:first-child { transition: padding-left 0.15s; }
    .order-row.selected td:first-child { padding-left: 20px; }
    .order-row.dragging { opacity: 0.5; background: rgba(212,175,55,0.1) !important; }
    .order-row.drag-over { border-top: 2px solid #D4AF37 !important; }
    .wl-item.border-primary\/20 { animation: wl-active-pulse 2s ease-in-out infinite; }
    @keyframes wl-active-pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(212,175,55,0); }
        50% { box-shadow: 0 0 12px 0 rgba(212,175,55,0.15); }
    }
</style>
</head>
<body class="bg-midnight text-text-off-white font-display h-screen flex flex-col overflow-hidden selection:bg-primary selection:text-midnight">

<!-- Top Navigation Bar (matching index.html) -->
<header class="border-b border-midnight-border bg-midnight/95 backdrop-blur sticky top-0 z-50 shrink-0">
    <div class="flex items-center justify-between px-4 md:px-8 py-3 md:py-4">
        <div class="flex items-center gap-2 md:gap-3">
            <img src="images/logo_azul.png" alt="InvertProfit" class="h-8 md:h-10" id="logo-img"/>
            <span class="text-xl md:text-2xl font-bold text-white" id="logo-text" style="display:none;">InvertProfit</span>
        </div>
        <script>
            document.getElementById('logo-img').onerror = function() {
                this.style.display = 'none';
                document.getElementById('logo-text').style.display = 'inline';
            };
        </script>
        <nav class="hidden lg:flex items-center gap-10">
            <a class="text-gray-400 hover:text-white transition text-lg" href="index.html">INICIO</a>
            <a class="text-gray-400 hover:text-white transition text-lg" href="portadanivelesacademia.html">ACADEMIA</a>
            <a class="text-white font-semibold border-b-2 border-primary pb-1 text-lg" href="mercado.html">MERCADOS</a>
            <a class="text-gray-400 hover:text-white transition text-lg" href="#">PORTAFOLIO</a>
        </nav>
        <div class="flex items-center gap-2 md:gap-4">
            <button class="bg-primary text-black font-bold px-3 md:px-6 py-2 md:py-3 rounded-lg flex items-center gap-2 hover:bg-primary/90 transition text-sm md:text-lg">
                <span>âš¡</span> <span class="hidden sm:inline">CONECTAR BROKER</span>
            </button>
            <div class="hidden md:flex items-center gap-3">
                <span class="text-gray-400 text-xl">ðŸ””</span>
                <div class="w-10 h-10 bg-gray-600 rounded-full"></div>
            </div>
            <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="lg:hidden text-gray-400 hover:text-white p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
    </div>
    <nav id="mobile-menu" class="hidden lg:hidden border-t border-midnight-border bg-midnight-card px-4 py-3 space-y-2">
        <a class="block text-gray-400 hover:text-white py-2 pl-3" href="index.html">INICIO</a>
        <a class="block text-gray-400 hover:text-white py-2 pl-3" href="portadanivelesacademia.html">ACADEMIA</a>
        <a class="block text-white font-semibold py-2 border-l-2 border-primary pl-3" href="mercado.html">MERCADOS</a>
        <a class="block text-gray-400 hover:text-white py-2 pl-3" href="#">PORTAFOLIO</a>
        <div class="flex items-center gap-3 pt-2 border-t border-midnight-border mt-2">
            <span class="text-gray-400 text-xl">ðŸ””</span>
            <div class="w-8 h-8 bg-gray-600 rounded-full"></div>
        </div>
    </nav>
</header>

<!-- Main Workspace -->
<main class="flex-1 grid grid-cols-1 lg:grid-cols-[64px_1fr_360px] gap-4 p-4 overflow-hidden h-[calc(100vh-73px)]">
    <!-- Left Toolbar -->
    <aside class="hidden lg:flex flex-col items-center py-4 gap-4 bg-midnight-card rounded-3xl border border-midnight-border overflow-y-auto">
        <button class="size-10 flex items-center justify-center rounded-xl bg-midnight-light text-primary hover:bg-primary hover:text-midnight transition-colors" title="Cursor">
            <span class="material-symbols-outlined">near_me</span>
        </button>
        <div class="w-8 h-px bg-midnight-border"></div>
        <button class="size-10 flex items-center justify-center rounded-xl text-text-muted hover:bg-midnight-light hover:text-white transition-colors" title="LÃ­nea">
            <span class="material-symbols-outlined">show_chart</span>
        </button>
        <button class="size-10 flex items-center justify-center rounded-xl text-text-muted hover:bg-midnight-light hover:text-white transition-colors" title="Horizontal">
            <span class="material-symbols-outlined">horizontal_rule</span>
        </button>
        <button class="size-10 flex items-center justify-center rounded-xl text-text-muted hover:bg-midnight-light hover:text-white transition-colors" title="Fibonacci">
            <span class="material-symbols-outlined">architecture</span>
        </button>
        <button class="size-10 flex items-center justify-center rounded-xl text-text-muted hover:bg-midnight-light hover:text-white transition-colors" title="Texto">
            <span class="material-symbols-outlined">text_fields</span>
        </button>
        <div class="flex-1"></div>
        <button class="size-10 flex items-center justify-center rounded-xl text-text-muted hover:bg-midnight-light hover:text-white transition-colors" title="Borrar">
            <span class="material-symbols-outlined">delete</span>
        </button>
    </aside>

    <!-- Center Column -->
    <section class="flex flex-col gap-4 min-w-0">
        <!-- Chart Container -->
        <div class="flex-1 flex flex-col bg-midnight-card rounded-3xl border border-midnight-border overflow-hidden relative shadow-2xl">
            <!-- Chart Header -->
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between px-4 py-3 border-b border-midnight-border bg-midnight-card/95 backdrop-blur-sm z-10 gap-3 md:gap-0">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div id="chart-icon-wrap" class="flex -space-x-2">
                            <div class="size-6 rounded-full bg-orange-500 flex items-center justify-center border-2 border-midnight-card"><span class="text-[8px] text-white font-bold">â‚¿</span></div>
                            <div class="size-6 rounded-full bg-green-800 flex items-center justify-center border-2 border-midnight-card"><span class="text-[8px] text-white font-bold">$</span></div>
                        </div>
                        <div>
                            <h3 id="chart-pair-label" class="text-white font-bold leading-none">BTC/USDT</h3>
                            <span id="chart-pair-sub" class="text-xs text-text-muted">Bitcoin vs US Dollar</span>
                        </div>
                    </div>
                    <div class="h-8 w-px bg-midnight-border mx-2 hidden md:block"></div>
                    <div class="flex items-baseline gap-2">
                        <span id="main-price" class="text-xl md:text-2xl font-mono font-medium text-chart-green">â€”</span>
                        <span id="main-change" class="text-xs font-bold text-text-muted bg-midnight-light px-1.5 py-0.5 rounded">â€”</span>
                    </div>
                    <div class="flex items-center gap-1.5 ml-2">
                        <span class="size-2 rounded-full bg-chart-green live-pulse"></span>
                        <span id="chart-update-time" class="text-[10px] font-mono text-text-muted">--:--:--</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="timeframe-btns" class="flex bg-midnight border border-midnight-border rounded-lg p-0.5">
                        <button data-tf="1" data-mul="minute" class="tf-btn px-2 md:px-3 py-1 text-xs font-medium text-text-muted hover:text-white rounded hover:bg-midnight-light">1m</button>
                        <button data-tf="5" data-mul="minute" class="tf-btn px-2 md:px-3 py-1 text-xs font-medium text-text-muted hover:text-white rounded hover:bg-midnight-light">5m</button>
                        <button data-tf="15" data-mul="minute" class="tf-btn px-2 md:px-3 py-1 text-xs font-medium text-text-muted hover:text-white rounded hover:bg-midnight-light">15m</button>
                        <button data-tf="1" data-mul="hour" class="tf-btn px-2 md:px-3 py-1 text-xs font-bold text-midnight bg-primary rounded shadow-sm">1H</button>
                        <button data-tf="1" data-mul="day" class="tf-btn px-2 md:px-3 py-1 text-xs font-medium text-text-muted hover:text-white rounded hover:bg-midnight-light">1D</button>
                    </div>
                    <div class="h-6 w-px bg-midnight-border hidden md:block"></div>
                    <button class="hidden md:flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-midnight-border hover:bg-midnight-light text-xs font-medium text-text-off-white transition-colors">
                        <span class="material-symbols-outlined text-[16px] text-primary">ssid_chart</span>
                        Indicadores
                    </button>
                </div>
            </div>

            <!-- TradingView Lightweight Chart -->
            <div id="tv-chart-container" class="flex-1 relative bg-[#0a0f18]" style="min-height:300px;">
                <div id="chart-loading" class="absolute inset-0 flex items-center justify-center bg-[#0a0f18] z-20">
                    <div class="flex flex-col items-center gap-3">
                        <div class="size-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-sm text-text-muted font-mono">Cargando velas...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Panel: Orders -->
        <div id="orders-panel" class="h-[200px] bg-midnight-card rounded-3xl border border-midnight-border flex flex-col overflow-hidden">
            <div class="flex items-center gap-6 px-4 md:px-6 border-b border-midnight-border bg-midnight-light/30 overflow-x-auto">
                <button class="order-tab py-3 text-sm font-bold text-primary border-b-2 border-primary whitespace-nowrap" data-tab="active">Ã“rdenes Activas (2)</button>
                <button class="order-tab py-3 text-sm font-medium text-text-muted hover:text-white transition-colors whitespace-nowrap" data-tab="history">Historial</button>
                <button class="order-tab py-3 text-sm font-medium text-text-muted hover:text-white transition-colors whitespace-nowrap" data-tab="positions">Posiciones</button>
                <div class="flex-1"></div>
                <span id="order-selection-info" class="text-[10px] font-mono text-primary hidden">1 seleccionada</span>
                <button class="text-xs font-medium text-text-muted flex items-center gap-1 hover:text-white transition-colors whitespace-nowrap">
                    <span class="material-symbols-outlined text-[16px]">filter_list</span> Filtrar
                </button>
            </div>
            <div class="flex-1 overflow-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-midnight sticky top-0 z-10">
                        <tr>
                            <th class="py-2 px-4 md:px-6 text-xs font-medium text-text-muted">Par</th>
                            <th class="py-2 px-4 md:px-6 text-xs font-medium text-text-muted">Tipo</th>
                            <th class="py-2 px-4 md:px-6 text-xs font-medium text-text-muted hidden md:table-cell">Precio Entrada</th>
                            <th class="py-2 px-4 md:px-6 text-xs font-medium text-text-muted">Precio Actual</th>
                            <th class="py-2 px-4 md:px-6 text-xs font-medium text-text-muted hidden md:table-cell">Cantidad</th>
                            <th class="py-2 px-4 md:px-6 text-xs font-medium text-text-muted hidden lg:table-cell">TP / SL</th>
                            <th class="py-2 px-4 md:px-6 text-xs font-medium text-text-muted text-right">PNL</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody" class="divide-y divide-midnight-border text-sm">
                        <tr class="order-row" draggable="true" data-order-id="1">
                            <td class="py-3 px-4 md:px-6 font-bold text-white flex items-center gap-2">
                                <div class="size-2 rounded-full bg-chart-green"></div> EUR/USD
                            </td>
                            <td class="py-3 px-4 md:px-6 text-chart-green font-medium">Compra</td>
                            <td class="py-3 px-4 md:px-6 font-mono text-text-off-white hidden md:table-cell">1.08200</td>
                            <td id="order-eurusd-price" class="py-3 px-4 md:px-6 font-mono text-text-off-white">â€”</td>
                            <td class="py-3 px-4 md:px-6 font-mono text-text-off-white hidden md:table-cell">0.5 Lot</td>
                            <td class="py-3 px-4 md:px-6 font-mono text-xs hidden lg:table-cell">
                                <span class="text-chart-green">1.0950</span> / <span class="text-chart-red">1.0780</span>
                            </td>
                            <td id="order-eurusd-pnl" class="py-3 px-4 md:px-6 text-right font-mono font-bold text-text-muted text-base">â€”</td>
                        </tr>
                        <tr class="order-row" draggable="true" data-order-id="2">
                            <td class="py-3 px-4 md:px-6 font-bold text-white flex items-center gap-2">
                                <div class="size-2 rounded-full bg-chart-red"></div> GBP/JPY
                            </td>
                            <td class="py-3 px-4 md:px-6 text-chart-red font-medium">Venta</td>
                            <td class="py-3 px-4 md:px-6 font-mono text-text-off-white hidden md:table-cell">192.450</td>
                            <td class="py-3 px-4 md:px-6 font-mono text-text-off-white">192.600</td>
                            <td class="py-3 px-4 md:px-6 font-mono text-text-off-white hidden md:table-cell">0.2 Lot</td>
                            <td class="py-3 px-4 md:px-6 font-mono text-xs hidden lg:table-cell">
                                <span class="text-chart-green">190.00</span> / <span class="text-chart-red">193.00</span>
                            </td>
                            <td class="py-3 px-4 md:px-6 text-right font-mono font-bold text-chart-red text-base">-$30.20</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Right Sidebar -->
    <aside class="hidden lg:flex flex-col gap-4 min-w-0">
        <!-- AI Analysis -->
        <div class="bg-gradient-to-b from-midnight-card to-midnight border border-primary/20 rounded-3xl p-5 shadow-[0_0_20px_rgba(212,175,55,0.05)] relative overflow-hidden">
            <div class="absolute top-0 right-0 p-3 opacity-10">
                <span class="material-symbols-outlined text-[120px] text-primary">psychology</span>
            </div>
            <div class="relative z-10 flex flex-col gap-4">
                <div class="flex items-center gap-2 mb-2">
                    <div class="flex items-center justify-center size-8 rounded-full bg-primary/20 text-primary">
                        <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white leading-none">AmigoTrade AI</h3>
                        <span class="text-xs text-primary font-medium">AnÃ¡lisis en Vivo</span>
                    </div>
                </div>
                <div class="bg-midnight-light/50 rounded-2xl p-4 border border-midnight-border backdrop-blur-sm">
                    <div class="flex items-start justify-between gap-2 mb-2">
                        <span class="text-xs font-bold uppercase tracking-wider text-text-muted">SeÃ±al Detectada</span>
                        <span id="ai-signal-badge" class="px-2 py-0.5 rounded text-[10px] font-bold bg-chart-green/20 text-chart-green border border-chart-green/30">ALCISTA</span>
                    </div>
                    <h4 id="ai-pattern" class="text-xl font-bold text-white mb-1">PatrÃ³n W (Doble Piso)</h4>
                    <p id="ai-description" class="text-sm text-text-muted leading-relaxed">
                        FormaciÃ³n de reversiÃ³n confirmada en marco de 4H. Zona de soporte fuerte en 1.08200.
                    </p>
                </div>
                <div class="bg-midnight-light/50 rounded-2xl p-4 border border-midnight-border backdrop-blur-sm flex items-center justify-between">
                    <div>
                        <span class="text-xs font-bold uppercase tracking-wider text-text-muted block mb-1">Indicadores</span>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-white">RSI (14)</span>
                            <span id="ai-rsi" class="text-sm font-mono text-primary font-bold">â€”</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span id="ai-rsi-label" class="text-xs font-medium text-text-muted">Calculando...</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-2">
                    <button class="py-3 rounded-full bg-chart-red/10 border border-chart-red/50 text-chart-red font-bold text-sm hover:bg-chart-red hover:text-white transition-all">Vender</button>
                    <button class="py-3 rounded-full bg-primary text-midnight font-bold text-sm hover:bg-white hover:shadow-[0_0_15px_rgba(212,175,55,0.4)] transition-all">Ejecutar Compra</button>
                </div>
            </div>
        </div>

        <!-- Watchlist -->
        <div class="flex-1 bg-midnight-card rounded-3xl border border-midnight-border flex flex-col overflow-hidden">
            <div class="px-5 py-3 border-b border-midnight-border flex items-center justify-between bg-midnight-light/30">
                <h3 class="text-sm font-bold text-white">Lista de Seguimiento</h3>
                <div class="flex items-center gap-2">
                    <span id="wl-update-count" class="text-[10px] font-mono text-text-muted/50"></span>
                    <span class="material-symbols-outlined text-text-muted text-[18px] cursor-pointer hover:text-white">more_horiz</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-2">
                <div id="watchlist" class="space-y-1">
                    <div data-ticker="X:BTCUSD" class="wl-item flex items-center justify-between p-3 rounded-xl hover:bg-midnight-light cursor-pointer group transition-all border border-primary/20 bg-primary/5">
                        <div class="flex items-center gap-3">
                            <div class="size-8 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-500 font-bold text-[10px] border border-orange-500/30">BTC</div>
                            <div>
                                <div class="text-sm font-bold text-white group-hover:text-primary transition-colors">BTC/USDT</div>
                                <div class="text-[10px] text-text-muted">Bitcoin</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="wl-price text-sm font-mono font-medium text-white">â€”</div>
                            <div class="wl-change text-[10px] font-medium text-text-muted">â€”</div>
                        </div>
                    </div>
                    <div data-ticker="C:EURUSD" class="wl-item flex items-center justify-between p-3 rounded-xl hover:bg-midnight-light cursor-pointer group transition-all bg-midnight-light/30">
                        <div class="flex items-center gap-3">
                            <div class="size-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500 font-bold text-[10px] border border-blue-500/30">EUR</div>
                            <div>
                                <div class="text-sm font-bold text-white group-hover:text-primary transition-colors">EUR/USD</div>
                                <div class="text-[10px] text-text-muted">Euro</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="wl-price text-sm font-mono font-medium text-white">â€”</div>
                            <div class="wl-change text-[10px] font-medium text-text-muted">â€”</div>
                        </div>
                    </div>
                    <div data-ticker="C:XAUUSD" class="wl-item flex items-center justify-between p-3 rounded-xl hover:bg-midnight-light cursor-pointer group transition-all">
                        <div class="flex items-center gap-3">
                            <div class="size-8 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-500 font-bold text-[10px] border border-yellow-500/30">XAU</div>
                            <div>
                                <div class="text-sm font-bold text-white group-hover:text-primary transition-colors">XAU/USD</div>
                                <div class="text-[10px] text-text-muted">Gold</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="wl-price text-sm font-mono font-medium text-white">â€”</div>
                            <div class="wl-change text-[10px] font-medium text-text-muted">â€”</div>
                        </div>
                    </div>
                    <div data-ticker="X:SOLUSD" class="wl-item flex items-center justify-between p-3 rounded-xl hover:bg-midnight-light cursor-pointer group transition-all">
                        <div class="flex items-center gap-3">
                            <div class="size-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-500 font-bold text-[10px] border border-indigo-500/30">SOL</div>
                            <div>
                                <div class="text-sm font-bold text-white group-hover:text-primary transition-colors">SOL/USDT</div>
                                <div class="text-[10px] text-text-muted">Solana</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="wl-price text-sm font-mono font-medium text-white">â€”</div>
                            <div class="wl-change text-[10px] font-medium text-text-muted">â€”</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>
</main>

<script>
(function(){
'use strict';

var API_KEY = 'Q3I6b14c8HL2l_A7faplgnuMTXekxCUU';
var BASE = 'https://api.polygon.io';

var ASSETS = {
    'X:BTCUSD': {label:'BTC/USDT', sub:'Bitcoin vs US Dollar', decimals:2, type:'crypto'},
    'C:EURUSD': {label:'EUR/USD', sub:'Euro vs US Dollar', decimals:5, type:'forex'},
    'C:XAUUSD': {label:'XAU/USD', sub:'Gold vs US Dollar', decimals:2, type:'forex'},
    'X:SOLUSD': {label:'SOL/USDT', sub:'Solana vs US Dollar', decimals:2, type:'crypto'}
};
var TICKERS = Object.keys(ASSETS);

var activeTicker = 'X:BTCUSD';
var chartTF = {mul:1, span:'hour'};
var candles = [];
var updateCount = 0;
var prices = {};
var prevPrices = {};
var prevCloses = {};

var tvChart = null;
var tvCandleSeries = null;
var tvVolumeSeries = null;
var tvEmaSeries = null;

var $ = function(id){ return document.getElementById(id); };
var $$ = function(s){ return document.querySelectorAll(s); };

function yyyymmdd(d){ return d.toISOString().slice(0,10); }
function ago(days){ var d=new Date(); d.setDate(d.getDate()-days); return yyyymmdd(d); }
function today(){ return yyyymmdd(new Date()); }

async function api(path){
    var sep = path.indexOf('?')>=0 ? '&' : '?';
    try { var r=await fetch(BASE+path+sep+'apiKey='+API_KEY); if(!r.ok)return null; return r.json(); }
    catch(e){ return null; }
}

async function getPrice(ticker){
    var data = await api('/v2/aggs/ticker/'+ticker+'/range/1/minute/'+ago(2)+'/'+today()+'?sort=desc&limit=3&adjusted=true');
    if(data && data.results && data.results.length){
        var latest = data.results[0];
        var pc = prevCloses[ticker] || latest.o;
        return {price:latest.c, change: pc ? ((latest.c-pc)/pc*100) : 0, ts:latest.t};
    }
    var prev = await api('/v2/aggs/ticker/'+ticker+'/prev?adjusted=true');
    if(prev && prev.results && prev.results.length){
        var r=prev.results[0];
        return {price:r.c, change:((r.c-r.o)/r.o*100), ts:r.t};
    }
    return null;
}

async function loadPrevCloses(){
    for(var i=0;i<TICKERS.length;i++){
        var data = await api('/v2/aggs/ticker/'+TICKERS[i]+'/prev?adjusted=true');
        if(data && data.results && data.results.length) prevCloses[TICKERS[i]] = data.results[0].c;
    }
}

async function getCandles(ticker, mul, span){
    var fromDate;
    if(span==='minute') fromDate = mul<=1?ago(2):mul<=5?ago(7):ago(14);
    else if(span==='hour') fromDate = ago(60);
    else if(span==='day') fromDate = ago(365);
    else fromDate = ago(730);
    var data = await api('/v2/aggs/ticker/'+ticker+'/range/'+mul+'/'+span+'/'+fromDate+'/'+today()+'?adjusted=true&sort=asc&limit=5000');
    if(data && data.results && data.results.length) return data.results;
    if(ASSETS[ticker].type==='forex' && span==='minute') return getCandles(ticker,1,'hour');
    return [];
}

function fmt(v,t){
    if(v==null) return 'â€”';
    var d = ASSETS[t] ? ASSETS[t].decimals : 2;
    if(d>2) return v.toFixed(d);
    return v.toLocaleString('en-US',{minimumFractionDigits:d, maximumFractionDigits:d});
}

function initChart(){
    var container = $('tv-chart-container');
    tvChart = LightweightCharts.createChart(container, {
        width: container.clientWidth, height: container.clientHeight,
        layout: { background:{type:'solid',color:'#0a0f18'}, textColor:'#8d9eb5', fontFamily:'Roboto Mono, monospace', fontSize:11 },
        grid: { vertLines:{color:'rgba(42,54,77,0.2)'}, horzLines:{color:'rgba(42,54,77,0.2)'} },
        crosshair: { mode:LightweightCharts.CrosshairMode.Normal, vertLine:{color:'rgba(212,175,55,0.3)',width:1,style:2,labelBackgroundColor:'#D4AF37'}, horzLine:{color:'rgba(212,175,55,0.3)',width:1,style:2,labelBackgroundColor:'#D4AF37'} },
        rightPriceScale: { borderColor:'#1f2937', scaleMargins:{top:0.05,bottom:0.15} },
        timeScale: { borderColor:'#1f2937', timeVisible:true, secondsVisible:false, rightOffset:8, barSpacing:8, minBarSpacing:4 },
        handleScroll: { vertTouchDrag:false },
    });
    tvCandleSeries = tvChart.addCandlestickSeries({ upColor:'#00C853', downColor:'#FF3D00', borderUpColor:'#00C853', borderDownColor:'#FF3D00', wickUpColor:'#00C853', wickDownColor:'#FF3D00' });
    tvVolumeSeries = tvChart.addHistogramSeries({ priceFormat:{type:'volume'}, priceScaleId:'volume' });
    tvChart.priceScale('volume').applyOptions({ scaleMargins:{top:0.85,bottom:0} });
    tvEmaSeries = tvChart.addLineSeries({ color:'#D4AF37', lineWidth:2, lineStyle:0, priceLineVisible:false, lastValueVisible:false, crosshairMarkerVisible:false });
    new ResizeObserver(function(){ tvChart.applyOptions({width:container.clientWidth,height:container.clientHeight}); }).observe(container);
}

function updateChartData(rawCandles){
    if(!tvCandleSeries || !rawCandles.length) return;
    var candleData=[], volumeData=[], seen={};
    for(var i=0;i<rawCandles.length;i++){
        var c=rawCandles[i]; var time=Math.floor(c.t/1000);
        if(seen[time]) continue; seen[time]=true;
        candleData.push({time:time,open:c.o,high:c.h,low:c.l,close:c.c});
        volumeData.push({time:time,value:c.v||0,color:c.c>=c.o?'rgba(0,200,83,0.15)':'rgba(255,61,0,0.15)'});
    }
    tvCandleSeries.setData(candleData);
    tvVolumeSeries.setData(volumeData);
    tvEmaSeries.setData(calcEMAforTV(candleData,20));
    if(candleData.length>60) tvChart.timeScale().setVisibleLogicalRange({from:candleData.length-60,to:candleData.length+5});
    else tvChart.timeScale().fitContent();
    tvChart.timeScale().scrollToRealTime();
}

function calcEMAforTV(data,period){
    if(data.length<period) return [];
    var k=2/(period+1), result=[], sum=0;
    for(var i=0;i<period;i++) sum+=data[i].close;
    var prev=sum/period;
    result.push({time:data[period-1].time,value:prev});
    for(var j=period;j<data.length;j++){
        var val=data[j].close*k+prev*(1-k);
        result.push({time:data[j].time,value:val}); prev=val;
    }
    return result;
}

function onUpdate(ticker){
    updateCount++;
    var d=prices[ticker]; if(!d) return;
    var el=document.querySelector('[data-ticker="'+ticker+'"]');
    if(el){
        var pEl=el.querySelector('.wl-price'), cEl=el.querySelector('.wl-change');
        if(pEl){
            var nv=fmt(d.price,ticker);
            if(pEl.textContent!==nv){
                var old=prevPrices[ticker]; pEl.textContent=nv;
                if(old!=null&&old!==d.price){ el.classList.remove('flash-up','flash-down'); void el.offsetWidth; el.classList.add(d.price>old?'flash-up':'flash-down'); }
                prevPrices[ticker]=d.price;
            }
        }
        if(cEl){ var pos=d.change>=0; cEl.textContent=(pos?'+':'')+d.change.toFixed(2)+'%'; cEl.className='wl-change text-[10px] font-medium '+(pos?'text-chart-green':'text-chart-red'); }
    }
    if(ticker===activeTicker){
        var mp=$('main-price'),mc=$('main-change');
        if(mp){ var p2=d.change>=0; mp.textContent=fmt(d.price,ticker); mp.className='text-xl md:text-2xl font-mono font-medium '+(p2?'text-chart-green':'text-chart-red')+' price-update';
            if(mc){ mc.textContent=(p2?'+':'')+d.change.toFixed(2)+'%'; mc.className='text-xs font-bold px-1.5 py-0.5 rounded '+(p2?'text-chart-green bg-chart-green/10':'text-chart-red bg-chart-red/10'); }
        }
    }
    if(ticker==='C:EURUSD'){
        var op=$('order-eurusd-price'); if(op) op.textContent=fmt(d.price,ticker);
        var pnl=$('order-eurusd-pnl');
        if(pnl){ var profit=(d.price-1.082)*50000; var pp=profit>=0; pnl.textContent=(pp?'+':'-')+'$'+Math.abs(profit).toFixed(2); pnl.className='py-3 px-4 md:px-6 text-right font-mono font-bold text-base '+(pp?'text-chart-green':'text-chart-red'); }
    }
    if(ticker===activeTicker&&candles.length>14){
        var closes=candles.map(function(c){return c.c;}); var rsi=calcRSI(closes,14); var rv=rsi[rsi.length-1];
        if(rv!=null){ $('ai-rsi').textContent=rv.toFixed(1); $('ai-rsi-label').textContent=rv<30?'Sobrevendido':rv>70?'Sobrecomprado':'Neutral'; $('ai-rsi-label').className='text-xs font-medium '+(rv<30?'text-chart-green':rv>70?'text-chart-red':'text-text-muted'); }
    }
    if(ticker===activeTicker&&tvCandleSeries&&candles.length){
        var lastCandle=candles[candles.length-1]; var newPrice=d.price; var time=Math.floor(lastCandle.t/1000);
        tvCandleSeries.update({time:time,open:lastCandle.o,high:Math.max(lastCandle.h,newPrice),low:Math.min(lastCandle.l,newPrice),close:newPrice});
        if(tvVolumeSeries) tvVolumeSeries.update({time:time,value:lastCandle.v||0,color:newPrice>=lastCandle.o?'rgba(0,200,83,0.15)':'rgba(255,61,0,0.15)'});
        tvChart.timeScale().scrollToRealTime();
    }
    $('wl-update-count').textContent='#'+updateCount;
}

function setStatus(mode){
    var dot=$('status-dot'),txt=$('status-text');
    if(!dot||!txt) return;
    if(mode==='live'){dot.className='size-2 rounded-full bg-chart-green live-pulse';txt.textContent='LIVE Â· REST';txt.className='text-chart-green font-bold';}
    else if(mode==='error'){dot.className='size-2 rounded-full bg-chart-red animate-pulse';txt.textContent='ERROR';txt.className='text-chart-red';}
    else{dot.className='size-2 rounded-full bg-text-muted animate-pulse';txt.textContent='Cargando...';txt.className='text-text-muted';}
}

function calcRSI(data,per){
    var r=[]; for(var i=0;i<data.length;i++) r.push(null);
    if(data.length<per+1) return r;
    var g=0,l=0;
    for(i=1;i<=per;i++){var d=data[i]-data[i-1];if(d>0)g+=d;else l-=d;}
    var ag=g/per,al=l/per;
    r[per]=al===0?100:100-(100/(1+ag/al));
    for(i=per+1;i<data.length;i++){var d2=data[i]-data[i-1];ag=(ag*(per-1)+Math.max(d2,0))/per;al=(al*(per-1)+Math.max(-d2,0))/per;r[i]=al===0?100:100-(100/(1+ag/al));}
    return r;
}

async function switchChart(ticker){
    if(ticker===activeTicker) return;
    activeTicker=ticker;
    $$('.wl-item').forEach(function(el){ var on=el.dataset.ticker===ticker; el.classList.toggle('border-primary/20',on); el.classList.toggle('bg-primary/5',on); el.classList.toggle('bg-midnight-light/30',!on); });
    var iconColors={'X:BTCUSD':{bg:'bg-orange-500',symbol:'â‚¿'},'C:EURUSD':{bg:'bg-blue-500',symbol:'â‚¬'},'C:XAUUSD':{bg:'bg-yellow-500',symbol:'Au'},'X:SOLUSD':{bg:'bg-indigo-500',symbol:'â—Ž'}};
    var ic=iconColors[ticker]||iconColors['X:BTCUSD'];
    $('chart-icon-wrap').innerHTML='<div class="size-6 rounded-full '+ic.bg+' flex items-center justify-center border-2 border-midnight-card"><span class="text-[8px] text-white font-bold">'+ic.symbol+'</span></div><div class="size-6 rounded-full bg-green-800 flex items-center justify-center border-2 border-midnight-card"><span class="text-[8px] text-white font-bold">$</span></div>';
    $('chart-pair-label').textContent=ASSETS[ticker].label;
    $('chart-pair-sub').textContent=ASSETS[ticker].sub;
    if(prices[ticker]) onUpdate(ticker);
    $('chart-loading').classList.remove('hidden');
    candles=await getCandles(ticker,chartTF.mul,chartTF.span);
    $('chart-loading').classList.add('hidden');
    if(candles.length) updateChartData(candles);
}

$$('.tf-btn').forEach(function(btn){
    btn.addEventListener('click',async function(){
        $$('.tf-btn').forEach(function(b){b.className='tf-btn px-2 md:px-3 py-1 text-xs font-medium text-text-muted hover:text-white rounded hover:bg-midnight-light';});
        btn.className='tf-btn px-2 md:px-3 py-1 text-xs font-bold text-midnight bg-primary rounded shadow-sm';
        chartTF={mul:parseInt(btn.dataset.tf),span:btn.dataset.mul};
        $('chart-loading').classList.remove('hidden');
        candles=await getCandles(activeTicker,chartTF.mul,chartTF.span);
        $('chart-loading').classList.add('hidden');
        if(candles.length) updateChartData(candles);
    });
});

$$('.wl-item').forEach(function(el){ el.addEventListener('click',function(){switchChart(el.dataset.ticker);}); });

(function initOrders(){
    var tbody=$('orders-tbody'); var rows=tbody.querySelectorAll('.order-row'); var selectedId=null;
    rows.forEach(function(row){
        row.addEventListener('click',function(){
            var id=row.dataset.orderId;
            if(selectedId===id){row.classList.remove('selected');selectedId=null;$('order-selection-info').classList.add('hidden');}
            else{rows.forEach(function(r){r.classList.remove('selected');});row.classList.add('selected');selectedId=id;$('order-selection-info').textContent='1 seleccionada';$('order-selection-info').classList.remove('hidden');}
        });
    });
    var dragRow=null;
    rows.forEach(function(row){
        row.addEventListener('dragstart',function(e){dragRow=row;row.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
        row.addEventListener('dragend',function(){row.classList.remove('dragging');rows.forEach(function(r){r.classList.remove('drag-over');});dragRow=null;});
        row.addEventListener('dragover',function(e){e.preventDefault();if(dragRow&&dragRow!==row){rows.forEach(function(r){r.classList.remove('drag-over');});row.classList.add('drag-over');}});
        row.addEventListener('drop',function(e){e.preventDefault();if(dragRow&&dragRow!==row){var parent=row.parentNode;parent.insertBefore(dragRow,row);row.classList.remove('drag-over');}});
    });
    $$('.order-tab').forEach(function(tab){
        tab.addEventListener('click',function(){
            $$('.order-tab').forEach(function(t){t.className='order-tab py-3 text-sm font-medium text-text-muted hover:text-white transition-colors whitespace-nowrap';});
            tab.className='order-tab py-3 text-sm font-bold text-primary border-b-2 border-primary whitespace-nowrap';
        });
    });
})();

var pollIdx=0, pollTotal=0;
async function pollOneTicker(){
    var ticker=TICKERS[pollIdx%TICKERS.length]; pollIdx++;
    var result=await getPrice(ticker);
    if(result){ var changed=!prices[ticker]||prices[ticker].price!==result.price; prices[ticker]=result; if(changed){onUpdate(ticker);pollTotal++;} }
}

async function refreshChart(){
    var fresh=await getCandles(activeTicker,chartTF.mul,chartTF.span);
    if(fresh.length){ candles=fresh; updateChartData(candles); }
}

async function init(){
    initChart();
    await loadPrevCloses();
    var ok=0;
    for(var i=0;i<TICKERS.length;i++){
        var t=TICKERS[i]; var r=await getPrice(t);
        if(r){prices[t]=r;onUpdate(t);ok++;}
    }
    if(!ok){
        $('chart-loading').innerHTML='<div class="flex flex-col items-center gap-3"><span class="material-symbols-outlined text-[48px] text-chart-red">error</span><span class="text-sm text-chart-red font-bold">Sin datos</span></div>';
        return;
    }
    candles=await getCandles(activeTicker,chartTF.mul,chartTF.span);
    $('chart-loading').classList.add('hidden');
    if(candles.length) updateChartData(candles);
    setInterval(function(){$('chart-update-time').textContent=new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});},1000);
    setInterval(pollOneTicker,5000);
    setInterval(refreshChart,20000);
    setInterval(function(){
        if(!tvCandleSeries||!candles.length||!prices[activeTicker]) return;
        var lastCandle=candles[candles.length-1]; var currentPrice=prices[activeTicker].price; var time=Math.floor(lastCandle.t/1000);
        var noise=currentPrice*(Math.random()-0.5)*0.0002; var simPrice=currentPrice+noise;
        tvCandleSeries.update({time:time,open:lastCandle.o,high:Math.max(lastCandle.h,simPrice),low:Math.min(lastCandle.l,simPrice),close:simPrice});
    },1500);
}

document.addEventListener('DOMContentLoaded',init);
})();
</script>
</body></html>
