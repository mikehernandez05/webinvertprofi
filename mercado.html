<!DOCTYPE html>
<html class="dark" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>InvertProfit ‚Äî Terminal de Trading</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%230a0f1a' width='32' height='32' rx='6'/><text x='50%25' y='55%25' dominant-baseline='central' text-anchor='middle' font-size='18' fill='%23D4AF37'>IP</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    // Dise√±o Master
                    "primary": "#D4AF37",
                    "bg-dark": "#0a0f1a",
                    "card": "#111827",
                    "card-border": "#1f2937",
                    "positive": "#22c55e",
                    "negative": "#ef4444",
                    
                    // Colores requeridos por la l√≥gica JS de mercado.html
                    "primary-dim": "rgba(212,175,55,0.12)",
                    "bg-main": "#0a0f1a", 
                    "bg-card": "#111827",
                    "bg-panel": "#111827", 
                    "bg-elevated": "#1f2937",
                    "bg-hover": "rgba(255,255,255,0.05)",
                    "border-main": "#1f2937",
                    "border-light": "#374151",
                    "text-w": "#ffffff",
                    "text-m": "#9ca3af",
                    "text-dim": "#6b7280",
                    "green": "#22c55e",
                    "green-dim": "rgba(34,197,94,0.12)",
                    "red": "#ef4444",
                    "red-dim": "rgba(239,68,68,0.12)",
                    "yellow": "#eab308",
                    "blue": "#3b82f6"
                },
                fontFamily: {
                    "sans": ["Inter", "sans-serif"],
                    "ui": ["Inter", "sans-serif"],
                    "mono": ["JetBrains Mono", "monospace"]
                }
            }
        }
    }
</script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}

/* Custom Scrollbar unificado con index.html */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: #D4AF37; }

/* ‚îÄ‚îÄ Efecto del Logo ‚îÄ‚îÄ */
.logo-glow {
    filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.3));
}

/* ‚îÄ‚îÄ Ticker Tape ‚îÄ‚îÄ */
@keyframes ticker { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }
.animate-ticker { animation: ticker 40s linear infinite; }

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes flash-g{0%{background:rgba(34,197,94,.15)}100%{background:transparent}}
@keyframes flash-r{0%{background:rgba(239,68,68,.15)}100%{background:transparent}}
@keyframes pdot{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes slideUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 4px rgba(212,175,55,0.2)}50%{box-shadow:0 0 12px rgba(212,175,55,0.4)}}

.fl-up{animation:flash-g .5s ease-out}
.fl-dn{animation:flash-r .5s ease-out}
.live-p{animation:pdot 1.5s ease-in-out infinite}
.slide-up{animation:slideUp .3s ease-out}
.fade-in{animation:fadeIn .2s ease-out}

/* ‚îÄ‚îÄ Market Watch ‚îÄ‚îÄ */
.mw-row{cursor:pointer;transition:all .15s ease}
.mw-row:hover{background:rgba(255,255,255,0.05)}
.mw-row.sel{background:rgba(212,175,55,.06);border-left:2px solid #D4AF37}

/* ‚îÄ‚îÄ Chart Slots ‚îÄ‚îÄ */
.chart-slot{position:relative;border:1px solid #1f2937;transition:border-color .2s,box-shadow .2s;overflow:hidden;display:flex;flex-direction:column}
.chart-slot:hover{border-color:#374151}.chart-slot.focused{border-color:rgba(212,175,55,.5);box-shadow:0 0 0 1px rgba(212,175,55,.15),inset 0 0 0 1px rgba(212,175,55,.05)}
.chart-slot .slot-close{position:absolute;top:6px;right:6px;z-index:20;opacity:0;transition:opacity .15s}
.chart-slot:hover .slot-close{opacity:1}

/* ‚îÄ‚îÄ Bottom Tabs ‚îÄ‚îÄ */
.chart-tab{cursor:pointer;transition:all .12s;border-bottom:2px solid transparent}
.chart-tab:hover{background:rgba(255,255,255,0.05)}
.chart-tab.active{border-bottom-color:#D4AF37;background:rgba(212,175,55,.05)}

/* ‚îÄ‚îÄ Category Tabs ‚îÄ‚îÄ */
.cat-btn{transition:all .15s;border-bottom:2px solid transparent}
.cat-btn.act{color:#D4AF37;font-weight:700;border-bottom-color:#D4AF37;background:rgba(212,175,55,.06)}

/* ‚îÄ‚îÄ Left Toolbar ‚îÄ‚îÄ */
.tool-btn{transition:all .15s;position:relative}
.tool-btn:hover{background:rgba(212,175,55,.08);color:#D4AF37}
.tool-btn.active{color:#D4AF37;background:rgba(212,175,55,.1)}
.tool-btn.active::before{content:'';position:absolute;left:0;top:25%;bottom:25%;width:2px;background:#D4AF37;border-radius:0 2px 2px 0}

/* ‚îÄ‚îÄ AmigoTrade AI Card ‚îÄ‚îÄ */
.ai-card{background:linear-gradient(135deg, rgba(17, 24, 39, 0.9), rgba(17, 24, 39, 0.7)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23134e4a;stop-opacity:0.3"/><stop offset="100%" style="stop-color:%230f172a;stop-opacity:0.1"/></linearGradient></defs><rect fill="url(%23g)" width="100" height="100"/></svg>');border:1px solid #1f2937;position:relative;overflow:hidden}
.ai-card::before{content:'';position:absolute;top:0;right:0;width:120px;height:120px;background:radial-gradient(circle,rgba(212,175,55,.06) 0%,transparent 70%);pointer-events:none}

/* ‚îÄ‚îÄ Signal Badge ‚îÄ‚îÄ */
.badge-alcista{background:rgba(34,197,94,.12);color:#22c55e;border:1px solid rgba(34,197,94,.2)}
.badge-bajista{background:rgba(239,68,68,.12);color:#ef4444;border:1px solid rgba(239,68,68,.2)}
.badge-neutral{background:rgba(156,163,175,.12);color:#9ca3af;border:1px solid rgba(156,163,175,.2)}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn-buy{background:#D4AF37;color:#0a0f1a;font-weight:700;border-radius:10px;transition:all .2s}
.btn-buy:hover{background:#e0c04a;box-shadow:0 4px 16px rgba(212,175,55,.25)}
.btn-sell{background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.25);font-weight:700;border-radius:10px;transition:all .2s}
.btn-sell:hover{background:rgba(239,68,68,.2)}

/* ‚îÄ‚îÄ Orders table ‚îÄ‚îÄ */
.order-tab{cursor:pointer;transition:all .15s;border-bottom:2px solid transparent;padding:8px 16px}
.order-tab:hover{color:#ffffff}
.order-tab.active{color:#ffffff;border-bottom-color:#D4AF37;font-weight:600}

/* ‚îÄ‚îÄ Settings gear ‚îÄ‚îÄ */
.gear-icon{transition:transform .3s ease}
.gear-icon:hover{transform:rotate(90deg)}

/* ‚îÄ‚îÄ Drawing mode indicator ‚îÄ‚îÄ */
.chart-slot.drawing-mode{cursor:crosshair!important}
.chart-slot.drawing-mode *{cursor:crosshair!important}

/* ‚îÄ‚îÄ Toast notification ‚îÄ‚îÄ */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #1f2937;color:#ffffff;padding:8px 18px;border-radius:10px;font-size:11px;font-weight:500;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1}
.toast.gold{border-color:rgba(212,175,55,.4);color:#D4AF37}

/* ‚îÄ‚îÄ Measure tooltip ‚îÄ‚îÄ */
.measure-tip{position:fixed;background:#111827;border:1px solid rgba(212,175,55,.3);color:#ffffff;padding:6px 12px;border-radius:8px;font-size:10px;font-family:'JetBrains Mono',monospace;z-index:300;pointer-events:none;display:none}

/* ‚îÄ‚îÄ Responsive panels ‚îÄ‚îÄ */
@media(max-width:1200px){
    .right-panel{display:none!important}
    .bottom-orders{display:none!important}
}
</style>
</head>
<body class="bg-bg-dark text-white font-sans antialiased h-screen flex flex-col overflow-hidden">

<header class="border-b border-card-border bg-bg-dark/95 backdrop-blur sticky top-0 z-50 shrink-0">
    <div class="flex items-center justify-between px-4 md:px-8 h-[64px]">
        <div class="flex items-center gap-2 md:gap-3">
            <a href="index.html" class="flex items-center gap-2">
                <img src="images/logo_azul.png" alt="InvertProfit" class="h-8 md:h-10 w-auto logo-glow object-contain" id="logo-img"/>
                <span class="text-lg md:text-xl font-bold text-white" id="logo-text" style="display:none;">InvertProfit</span>
            </a>
        </div>
        <nav class="hidden lg:flex items-center gap-10">
            <a class="text-gray-400 hover:text-white transition text-lg" href="index.html">INICIO</a>
            <a class="text-gray-400 hover:text-white transition text-lg" href="portadanivelesacademia.html">ACADEMIA</a>
            <a class="text-white font-semibold border-b-2 border-primary pb-1 text-lg" href="mercado.html">MERCADOS</a>
            <a class="text-gray-400 hover:text-white transition text-lg" href="#">PORTAFOLIO</a>
        </nav>
        <div class="flex items-center gap-3 md:gap-4 shrink-0">
            <div class="hidden md:flex items-center gap-1.5 mr-1">
                <span id="ws-dot" class="size-2 rounded-full bg-gray-400"></span>
                <span id="ws-lbl" class="text-[11px] font-mono text-gray-400">Conectando...</span>
            </div>
            <button class="shrink-0 bg-primary text-bg-black font-bold h-10 px-6 rounded-full inline-flex items-center gap-2 whitespace-nowrap hover:bg-primary/90 transition text-xs sm:text-sm tracking-wide leading-none">
                <span class="leading-none">‚ö°</span>
                <span class="leading-none">CONECTAR BROKER</span>
            </button>
            <div class="hidden md:flex items-center gap-3">
                <span class="text-gray-400 text-xl">üîî</span>
                <div class="w-10 h-10 bg-gray-600 rounded-full"></div>
            </div>
            <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="lg:hidden text-gray-400 hover:text-white p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
    </div>
    <!-- Mobile nav -->
    <nav id="mobile-menu" class="hidden lg:hidden border-t border-card-border bg-card px-4 py-3 space-y-2">
        <a class="block text-gray-400 hover:text-white py-2 pl-3" href="index.html">INICIO</a>
        <a class="block text-gray-400 hover:text-white py-2 pl-3" href="portadanivelesacademia.html">ACADEMIA</a>
        <a class="block text-white font-semibold py-2 border-l-2 border-primary pl-3" href="mercado.html">MERCADOS</a>
        <a class="block text-gray-400 hover:text-white py-2 pl-3" href="#">PORTAFOLIO</a>
        <div class="flex items-center gap-3 pt-2 border-t border-card-border mt-2">
            <span class="text-gray-400 text-xl">üîî</span>
            <div class="w-8 h-8 bg-gray-600 rounded-full"></div>
        </div>
    </nav>
    <!-- Ticker Tape -->
    <div class="bg-card border-t border-card-border overflow-hidden py-1.5">
        <div class="animate-ticker whitespace-nowrap flex text-xs" id="ticker-tape"></div>
    </div>
</header>

<script>
    document.getElementById('logo-img').onerror = function() {
        this.style.display = 'none';
        document.getElementById('logo-text').style.display = 'inline';
    };
</script>

<div class="flex-1 flex overflow-hidden">

<aside class="w-[46px] shrink-0 border-r border-card-border bg-card flex flex-col items-center py-3 gap-1">
    <button class="tool-btn active w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="cursor" title="Cursor (Esc)">
        <span class="material-symbols-outlined text-[18px]">near_me</span>
    </button>
    <button class="tool-btn w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="hline" title="L√≠nea Horizontal ‚Äî click en gr√°fico">
        <span class="material-symbols-outlined text-[18px]">horizontal_rule</span>
    </button>
    <button class="tool-btn w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="trendline" title="L√≠nea de Tendencia ‚Äî click 2 puntos">
        <span class="material-symbols-outlined text-[18px]">show_chart</span>
    </button>
    <button class="tool-btn w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="fibonacci" title="Fibonacci ‚Äî click 2 puntos">
        <span class="material-symbols-outlined text-[18px]">straighten</span>
    </button>
    <button class="tool-btn w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="marker" title="Marcador ‚Äî click en gr√°fico">
        <span class="material-symbols-outlined text-[18px]">push_pin</span>
    </button>
    <button class="tool-btn w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="measure" title="Medir ‚Äî click 2 puntos">
        <span class="material-symbols-outlined text-[18px]">square_foot</span>
    </button>
    <button class="tool-btn w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="screenshot" title="Captura del gr√°fico">
        <span class="material-symbols-outlined text-[18px]">photo_camera</span>
    </button>
    <div class="flex-1"></div>
    <button class="tool-btn w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="toggleEMA" title="Mostrar/Ocultar EMA 20">
        <span class="material-symbols-outlined text-[18px]">timeline</span>
    </button>
    <button class="tool-btn w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="toggleVol" title="Mostrar/Ocultar Volumen">
        <span class="material-symbols-outlined text-[18px]">bar_chart</span>
    </button>
    <button class="tool-btn w-9 h-9 rounded-lg flex items-center justify-center text-gray-400" data-tool="delete" title="Borrar dibujos del gr√°fico activo">
        <span class="material-symbols-outlined text-[18px]">delete</span>
    </button>
</aside>

<div class="flex-1 flex flex-col min-w-0">
    <div id="chart-grid" class="flex-1 grid grid-cols-2 grid-rows-2 gap-[1px] bg-card-border/50 min-h-0">
        <div class="chart-slot bg-bg-dark focused" id="slot-0" data-idx="0">
            <div class="slot-header flex items-center justify-between px-3 py-1.5 bg-card/80 backdrop-blur border-b border-card-border shrink-0">
                <div class="flex items-center gap-2">
                    <div class="slot-icon size-[22px] rounded-md flex items-center justify-center text-[7px] font-bold bg-gray-500/20 text-gray-500">‚Äî</div>
                    <div class="flex flex-col">
                        <span class="slot-label text-[11px] font-bold text-gray-400 leading-tight">Vac√≠o</span>
                    </div>
                    <div class="flex items-center gap-0.5 ml-2">
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="1-minute">1m</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="5-minute">5m</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded bg-primary/10 text-primary font-bold" data-tf="1-hour">1H</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="4-hour">4H</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="1-day">1D</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="slot-price text-[12px] font-mono font-semibold text-gray-400">‚Äî</span>
                    <span class="slot-change text-[9px] font-bold px-1.5 py-0.5 rounded text-gray-400">‚Äî</span>
                </div>
            </div>
            <button class="slot-close size-5 flex items-center justify-center rounded bg-card/90 text-gray-400 hover:text-red-500 hover:bg-card transition" title="Cerrar"><span class="material-symbols-outlined text-[13px]">close</span></button>
            <div class="slot-chart flex-1 bg-bg-dark"></div>
            <div class="slot-empty absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                    <span class="material-symbols-outlined text-[36px] text-gray-600">candlestick_chart</span>
                    <p class="text-[10px] text-gray-500 mt-1.5">Click en Lista de Seguimiento</p>
                </div>
            </div>
        </div>
        <div class="chart-slot bg-bg-dark" id="slot-1" data-idx="1">
            <div class="slot-header flex items-center justify-between px-3 py-1.5 bg-card/80 backdrop-blur border-b border-card-border shrink-0">
                <div class="flex items-center gap-2">
                    <div class="slot-icon size-[22px] rounded-md flex items-center justify-center text-[7px] font-bold bg-gray-500/20 text-gray-500">‚Äî</div>
                    <span class="slot-label text-[11px] font-bold text-gray-400">Vac√≠o</span>
                    <div class="flex items-center gap-0.5 ml-2">
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="1-minute">1m</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="5-minute">5m</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded bg-primary/10 text-primary font-bold" data-tf="1-hour">1H</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="4-hour">4H</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="1-day">1D</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="slot-price text-[12px] font-mono font-semibold text-gray-400">‚Äî</span>
                    <span class="slot-change text-[9px] font-bold px-1.5 py-0.5 rounded text-gray-400">‚Äî</span>
                </div>
            </div>
            <button class="slot-close size-5 flex items-center justify-center rounded bg-card/90 text-gray-400 hover:text-red-500 hover:bg-card transition" title="Cerrar"><span class="material-symbols-outlined text-[13px]">close</span></button>
            <div class="slot-chart flex-1 bg-bg-dark"></div>
            <div class="slot-empty absolute inset-0 flex items-center justify-center">
                <div class="text-center"><span class="material-symbols-outlined text-[36px] text-gray-600">candlestick_chart</span><p class="text-[10px] text-gray-500 mt-1.5">Slot disponible</p></div>
            </div>
        </div>
        <div class="chart-slot bg-bg-dark" id="slot-2" data-idx="2">
            <div class="slot-header flex items-center justify-between px-3 py-1.5 bg-card/80 backdrop-blur border-b border-card-border shrink-0">
                <div class="flex items-center gap-2">
                    <div class="slot-icon size-[22px] rounded-md flex items-center justify-center text-[7px] font-bold bg-gray-500/20 text-gray-500">‚Äî</div>
                    <span class="slot-label text-[11px] font-bold text-gray-400">Vac√≠o</span>
                    <div class="flex items-center gap-0.5 ml-2">
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="1-minute">1m</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="5-minute">5m</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded bg-primary/10 text-primary font-bold" data-tf="1-hour">1H</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="4-hour">4H</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="1-day">1D</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="slot-price text-[12px] font-mono font-semibold text-gray-400">‚Äî</span>
                    <span class="slot-change text-[9px] font-bold px-1.5 py-0.5 rounded text-gray-400">‚Äî</span>
                </div>
            </div>
            <button class="slot-close size-5 flex items-center justify-center rounded bg-card/90 text-gray-400 hover:text-red-500 hover:bg-card transition" title="Cerrar"><span class="material-symbols-outlined text-[13px]">close</span></button>
            <div class="slot-chart flex-1 bg-bg-dark"></div>
            <div class="slot-empty absolute inset-0 flex items-center justify-center">
                <div class="text-center"><span class="material-symbols-outlined text-[36px] text-gray-600">candlestick_chart</span><p class="text-[10px] text-gray-500 mt-1.5">Slot disponible</p></div>
            </div>
        </div>
        <div class="chart-slot bg-bg-dark" id="slot-3" data-idx="3">
            <div class="slot-header flex items-center justify-between px-3 py-1.5 bg-card/80 backdrop-blur border-b border-card-border shrink-0">
                <div class="flex items-center gap-2">
                    <div class="slot-icon size-[22px] rounded-md flex items-center justify-center text-[7px] font-bold bg-gray-500/20 text-gray-500">‚Äî</div>
                    <span class="slot-label text-[11px] font-bold text-gray-400">Vac√≠o</span>
                    <div class="flex items-center gap-0.5 ml-2">
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="1-minute">1m</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="5-minute">5m</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded bg-primary/10 text-primary font-bold" data-tf="1-hour">1H</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="4-hour">4H</button>
                        <button class="slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition" data-tf="1-day">1D</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="slot-price text-[12px] font-mono font-semibold text-gray-400">‚Äî</span>
                    <span class="slot-change text-[9px] font-bold px-1.5 py-0.5 rounded text-gray-400">‚Äî</span>
                </div>
            </div>
            <button class="slot-close size-5 flex items-center justify-center rounded bg-card/90 text-gray-400 hover:text-red-500 hover:bg-card transition" title="Cerrar"><span class="material-symbols-outlined text-[13px]">close</span></button>
            <div class="slot-chart flex-1 bg-bg-dark"></div>
            <div class="slot-empty absolute inset-0 flex items-center justify-center">
                <div class="text-center"><span class="material-symbols-outlined text-[36px] text-gray-600">candlestick_chart</span><p class="text-[10px] text-gray-500 mt-1.5">Slot disponible</p></div>
            </div>
        </div>
    </div>

    <div class="shrink-0 border-t border-card-border bg-card">
        <div class="h-[28px] flex items-center overflow-x-auto px-1 gap-0.5 border-b border-card-border/50" id="bottom-tabs">
            <span class="text-[8px] text-gray-500 font-mono px-2 shrink-0">Gr√°ficos:</span>
        </div>
        <div class="bottom-orders h-[140px] flex flex-col">
            <div class="flex items-center border-b border-card-border/50 px-2 shrink-0">
                <button class="order-tab active text-[11px] text-gray-400" data-otab="active">√ìrdenes Activas <span class="text-primary font-mono text-[10px]">(2)</span></button>
                <button class="order-tab text-[11px] text-gray-400" data-otab="history">Historial</button>
                <button class="order-tab text-[11px] text-gray-400" data-otab="positions">Posiciones</button>
                <div class="flex-1"></div>
                <button class="flex items-center gap-1 text-[10px] text-gray-400 hover:text-white transition px-2 py-1">
                    <span class="material-symbols-outlined text-[13px]">filter_list</span> Filtrar
                </button>
            </div>
            <div class="flex-1 overflow-auto">
                <table class="w-full text-[10px]">
                    <thead>
                        <tr class="text-gray-500 uppercase tracking-wider border-b border-card-border/30">
                            <th class="text-left py-1.5 px-3 font-medium">Par</th>
                            <th class="text-left py-1.5 px-2 font-medium">Tipo</th>
                            <th class="text-right py-1.5 px-2 font-medium">Precio Entrada</th>
                            <th class="text-right py-1.5 px-2 font-medium">Precio Actual</th>
                            <th class="text-right py-1.5 px-2 font-medium">Cantidad</th>
                            <th class="text-right py-1.5 px-2 font-medium">TP / SL</th>
                            <th class="text-right py-1.5 px-3 font-medium">PNL</th>
                        </tr>
                    </thead>
                    <tbody id="orders-body">
                        <tr class="border-b border-card-border/20 hover:bg-white/5 transition">
                            <td class="py-2 px-3 font-semibold text-white"><span class="inline-block size-1.5 rounded-full bg-green-500 mr-1.5"></span>EUR/USD</td>
                            <td class="py-2 px-2 text-green-500 font-semibold">Compra (Long)</td>
                            <td class="py-2 px-2 text-right font-mono text-white">1.08200</td>
                            <td class="py-2 px-2 text-right font-mono text-white">1.08456</td>
                            <td class="py-2 px-2 text-right font-mono text-gray-400">0.5 Lot</td>
                            <td class="py-2 px-2 text-right font-mono"><span class="text-green-500">1.0950</span> / <span class="text-red-500">1.0780</span></td>
                            <td class="py-2 px-3 text-right font-mono font-bold text-green-500">+$128.50</td>
                        </tr>
                        <tr class="border-b border-card-border/20 hover:bg-white/5 transition">
                            <td class="py-2 px-3 font-semibold text-white"><span class="inline-block size-1.5 rounded-full bg-red-500 mr-1.5"></span>GBP/JPY</td>
                            <td class="py-2 px-2 text-red-500 font-semibold">Venta (Short)</td>
                            <td class="py-2 px-2 text-right font-mono text-white">192.450</td>
                            <td class="py-2 px-2 text-right font-mono text-white">192.600</td>
                            <td class="py-2 px-2 text-right font-mono text-gray-400">0.2 Lot</td>
                            <td class="py-2 px-2 text-right font-mono"><span class="text-green-500">190.00</span> / <span class="text-red-500">193.00</span></td>
                            <td class="py-2 px-3 text-right font-mono font-bold text-red-500">-$30.20</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<aside class="right-panel w-[280px] shrink-0 border-l border-card-border bg-card flex flex-col overflow-hidden">

    <div class="p-3 border-b border-card-border shrink-0">
        <div class="ai-card p-3 rounded-xl">
            <div class="flex items-center justify-between mb-3 relative z-10">
                <div>
                    <h3 class="text-[13px] font-bold text-white flex items-center gap-1.5">
                        <span class="text-primary">‚ö°</span> AmigoTrade AI
                    </h3>
                    <p class="text-[9px] text-green-500 font-mono flex items-center gap-1 mt-0.5">
                        <span class="size-1.5 rounded-full bg-green-500 live-p inline-block"></span>
                        An√°lisis en Vivo
                    </p>
                </div>
                <span class="material-symbols-outlined text-[22px] text-gray-500 gear-icon cursor-pointer hover:text-primary transition">settings</span>
            </div>

            <div id="ai-signal" class="bg-bg-dark/60 rounded-lg p-2.5 mb-2.5 border border-card-border/50 relative z-10">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-[9px] font-bold text-gray-400 uppercase tracking-wider">Se√±al Detectada</span>
                    <span id="ai-badge" class="badge-neutral text-[8px] font-bold px-2 py-0.5 rounded-full">ESPERANDO</span>
                </div>
                <h4 id="ai-pattern" class="text-[13px] font-bold text-white mb-1">Analizando...</h4>
                <p id="ai-desc" class="text-[10px] text-gray-400 leading-relaxed">Selecciona un activo para recibir an√°lisis en tiempo real.</p>
            </div>

            <div class="bg-bg-dark/60 rounded-lg p-2.5 mb-3 border border-card-border/50 relative z-10">
                <span class="text-[9px] font-bold text-gray-400 uppercase tracking-wider">Indicadores</span>
                <div class="flex items-center justify-between mt-1.5">
                    <span class="text-[11px] font-mono text-white">RSI (14) <strong id="ai-rsi">‚Äî</strong></span>
                    <span id="ai-rsi-label" class="text-[9px] font-bold text-gray-400">‚Äî</span>
                </div>
                <div class="w-full h-1 bg-bg-dark rounded-full mt-1.5 overflow-hidden">
                    <div id="ai-rsi-bar" class="h-full rounded-full bg-gray-400 transition-all duration-500" style="width:50%"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 relative z-10">
                <button class="btn-sell py-2 text-[11px]">Vender</button>
                <button class="btn-buy py-2 text-[11px]">Ejecutar Compra</button>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col min-h-0">
        <div class="px-3 py-2 border-b border-card-border flex items-center justify-between shrink-0">
            <span class="text-[12px] font-bold text-white">Lista de Seguimiento</span>
            <button class="text-gray-400 hover:text-white transition">
                <span class="material-symbols-outlined text-[16px]">more_horiz</span>
            </button>
        </div>
        <div class="px-3 py-1.5 border-b border-card-border/50 shrink-0">
            <div class="flex items-center gap-1.5 bg-bg-dark/80 rounded-md px-2 py-1 border border-card-border/50">
                <span class="material-symbols-outlined text-[14px] text-gray-500">search</span>
                <input id="mw-search" type="text" placeholder="Filtrar activos..." class="bg-transparent text-[10px] text-white placeholder-gray-500 outline-none w-full font-sans border-none focus:ring-0 p-0"/>
            </div>
        </div>
        <div class="flex border-b border-card-border shrink-0">
            <button class="cat-btn act flex-1 py-1.5 text-[9px] text-gray-400" data-cat="all">Todo</button>
            <button class="cat-btn flex-1 py-1.5 text-[9px] text-gray-400" data-cat="indices">IDX</button>
            <button class="cat-btn flex-1 py-1.5 text-[9px] text-gray-400" data-cat="forex">FX</button>
            <button class="cat-btn flex-1 py-1.5 text-[9px] text-gray-400" data-cat="commodities">COM</button>
            <button class="cat-btn flex-1 py-1.5 text-[9px] text-gray-400" data-cat="crypto">CRY</button>
        </div>
        <div class="flex-1 overflow-y-auto" id="mw-list"></div>
    </div>
</aside>

</div>

<div id="toast" class="toast"></div>
<div id="measure-tip" class="measure-tip"></div>

<script>
(function(){
'use strict';

/* ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ */
var API_KEY='Q3I6b14c8HL2l_A7faplgnuMTXekxCUU';
var BASE='https://api.polygon.io';
var WS_URLS={crypto:'wss://socket.polygon.io/crypto',forex:'wss://socket.polygon.io/forex',stocks:'wss://socket.polygon.io/stocks'};

/* Plan capabilities ‚Äî Stocks Advanced: stocks full, forex/crypto limited */
var PLAN={
    wsEnabled:    {stocks:true, forex:false, crypto:false},
    snapEnabled:  {stocks:true, forex:true,  crypto:false}
};

var ASSETS={
    'SPY':       {label:'S&P 500', sub:'SPY',    d:2,ws:'stocks',cat:'indices',color:'#10b981',abbr:'SPX'},
    'QQQ':       {label:'NASDAQ',  sub:'QQQ',    d:2,ws:'stocks',cat:'indices',color:'#6366f1',abbr:'NDQ'},
    'DIA':       {label:'DOW 30',  sub:'DIA',    d:2,ws:'stocks',cat:'indices',color:'#3b82f6',abbr:'DOW'},
    'C:EURUSD':  {label:'EUR/USD', sub:'Euro',   d:5,ws:'forex',cat:'forex',color:'#3b82f6',abbr:'EUR'},
    'C:GBPUSD':  {label:'GBP/USD', sub:'Libra',  d:5,ws:'forex',cat:'forex',color:'#ef4444',abbr:'GBP'},
    'C:USDJPY':  {label:'USD/JPY', sub:'Yen',    d:3,ws:'forex',cat:'forex',color:'#f43f5e',abbr:'JPY'},
    'C:AUDUSD':  {label:'AUD/USD', sub:'AUD',    d:5,ws:'forex',cat:'forex',color:'#22c55e',abbr:'AUD'},
    'C:USDCAD':  {label:'USD/CAD', sub:'CAD',    d:5,ws:'forex',cat:'forex',color:'#dc2626',abbr:'CAD'},
    'C:USDCHF':  {label:'USD/CHF', sub:'CHF',    d:5,ws:'forex',cat:'forex',color:'#ef4444',abbr:'CHF'},
    'C:NZDUSD':  {label:'NZD/USD', sub:'NZD',    d:5,ws:'forex',cat:'forex',color:'#14b8a6',abbr:'NZD'},
    'C:EURGBP':  {label:'EUR/GBP', sub:'E/G',    d:5,ws:'forex',cat:'forex',color:'#8b5cf6',abbr:'E/G'},
    'C:XAUUSD':  {label:'XAU/USD', sub:'Oro',    d:2,ws:'forex',cat:'commodities',color:'#eab308',abbr:'XAU'},
    'C:XAGUSD':  {label:'XAG/USD', sub:'Plata',  d:3,ws:'forex',cat:'commodities',color:'#9ca3af',abbr:'XAG'},
    'X:BTCUSD':  {label:'BTC/USD', sub:'Bitcoin', d:2,ws:'crypto',cat:'crypto',color:'#f97316',abbr:'BTC'},
    'X:ETHUSD':  {label:'ETH/USD', sub:'Ethereum',d:2,ws:'crypto',cat:'crypto',color:'#60a5fa',abbr:'ETH'},
    'X:SOLUSD':  {label:'SOL/USD', sub:'Solana',  d:2,ws:'crypto',cat:'crypto',color:'#818cf8',abbr:'SOL'},
    'X:XRPUSD':  {label:'XRP/USD', sub:'XRP',    d:4,ws:'crypto',cat:'crypto',color:'#94a3b8',abbr:'XRP'},
    'X:ADAUSD':  {label:'ADA/USD', sub:'Cardano', d:4,ws:'crypto',cat:'crypto',color:'#38bdf8',abbr:'ADA'},
    'X:DOGEUSD': {label:'DOGE/USD',sub:'Dogecoin',d:5,ws:'crypto',cat:'crypto',color:'#facc15',abbr:'DOGE'},
    'X:AVAXUSD': {label:'AVAX/USD',sub:'Avalanche',d:2,ws:'crypto',cat:'crypto',color:'#ef4444',abbr:'AVAX'},
    'X:LINKUSD': {label:'LINK/USD',sub:'Chainlink',d:3,ws:'crypto',cat:'crypto',color:'#2563eb',abbr:'LINK'},
    'X:DOTUSD':  {label:'DOT/USD', sub:'Polkadot', d:3,ws:'crypto',cat:'crypto',color:'#ec4899',abbr:'DOT'},
    'X:POLUSD': {label:'POL/USD', sub:'Polygon',  d:4,ws:'crypto',cat:'crypto',color:'#a855f7',abbr:'POL'}
};
var TICKERS=Object.keys(ASSETS);

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
var prices={},prevPrices={},prevCloses={};
var wsConns={},wsAlive={crypto:false,forex:false,stocks:false},wsThrottle={};
var slots=[null,null,null,null];
var focusedSlot=0;
var currentCat='all';
var currentMWSearch='';

var $=function(id){return document.getElementById(id)};
var $$=function(s){return document.querySelectorAll(s)};

/* ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ */
function yyyymmdd(d){return d.toISOString().slice(0,10)}
function ago(n){var d=new Date();d.setDate(d.getDate()-n);return yyyymmdd(d)}
function today(){return yyyymmdd(new Date())}
function fmt(v,t){if(v==null)return'‚Äî';var dd=ASSETS[t]?ASSETS[t].d:2;return dd>2?v.toFixed(dd):v.toLocaleString('en-US',{minimumFractionDigits:dd,maximumFractionDigits:dd})}

/* ‚ïê‚ïê‚ïê REST API ‚ïê‚ïê‚ïê */
var apiCalls=0,apiErrors=0;
async function api(path){
    var sep=path.indexOf('?')>=0?'&':'?';
    apiCalls++;
    try{
        var r=await fetch(BASE+path+sep+'apiKey='+API_KEY);
        if(!r.ok){apiErrors++;console.warn('[Polygon] HTTP',r.status,'‚Üí',path.split('?')[0]);return null;}
        var j=await r.json();
        if(j.status==='ERROR'||j.status==='NOT_FOUND'){console.warn('[Polygon]',j.status,j.message||'',path.split('?')[0]);return null;}
        return j;
    }catch(e){apiErrors++;console.warn('[Polygon] Network error:',e.message);return null;}
}

/* ‚îÄ‚îÄ Snapshot bulk load (3 calls instead of ~48) ‚îÄ‚îÄ */
async function loadSnapshots(){
    var loaded=0;
    console.log('[Polygon] Cargando snapshots...');

    // 1) Stocks snapshot
    var stockTickers=TICKERS.filter(function(t){return ASSETS[t].ws==='stocks';});
    var stocksSnap=await api('/v2/snapshot/locale/us/markets/stocks/tickers?tickers='+stockTickers.join(','));
    if(stocksSnap&&stocksSnap.tickers){
        stocksSnap.tickers.forEach(function(s){
            var tk=s.ticker;if(!ASSETS[tk])return;
            var price=null;
            if(s.lastTrade&&s.lastTrade.p) price=s.lastTrade.p;
            else if(s.day&&s.day.c) price=s.day.c;
            else if(s.prevDay&&s.prevDay.c) price=s.prevDay.c;
            if(!price)return;
            if(s.prevDay&&s.prevDay.c) prevCloses[tk]=s.prevDay.c;
            prices[tk]={price:price,change:s.todaysChangePerc||0,ts:s.updated||Date.now()};
            updateMW(tk);loaded++;
        });
        console.log('[Polygon] Stocks:',stocksSnap.tickers.length,'tickers cargados');
    }else{
        console.log('[Polygon] Stocks snapshot no disponible, usando aggregates...');
        await loadFallback(stockTickers);loaded+=stockTickers.length;
    }

    // 2) Forex snapshot
    var fxTickers=TICKERS.filter(function(t){return ASSETS[t].ws==='forex';});
    var fxSnap=await api('/v2/snapshot/locale/global/markets/forex/tickers?tickers='+fxTickers.join(','));
    if(fxSnap&&fxSnap.tickers){
        fxSnap.tickers.forEach(function(s){
            var tk=s.ticker;if(!ASSETS[tk])return;
            var price=null;
            if(s.lastQuote){price=(s.lastQuote.a+s.lastQuote.b)/2;}
            else if(s.min&&s.min.c) price=s.min.c;
            else if(s.day&&s.day.c) price=s.day.c;
            else if(s.prevDay&&s.prevDay.c) price=s.prevDay.c;
            if(!price)return;
            if(s.prevDay&&s.prevDay.c) prevCloses[tk]=s.prevDay.c;
            prices[tk]={price:price,change:s.todaysChangePerc||0,ts:s.updated||Date.now()};
            updateMW(tk);loaded++;
        });
        console.log('[Polygon] Forex:',fxSnap.tickers.length,'pares cargados');
    }else{
        console.log('[Polygon] Forex snapshot no disponible, usando aggregates...');
        await loadFallback(fxTickers);loaded+=fxTickers.length;
    }

    // 3) Crypto ‚Äî snapshot no disponible en plan actual, usar aggregates directamente
    var cryptoTickers=TICKERS.filter(function(t){return ASSETS[t].ws==='crypto';});
    if(PLAN.snapEnabled.crypto){
        var cryptoSnap=await api('/v2/snapshot/locale/global/markets/crypto/tickers?tickers='+cryptoTickers.join(','));
        if(cryptoSnap&&cryptoSnap.tickers){
            cryptoSnap.tickers.forEach(function(s){
                var tk=s.ticker;if(!ASSETS[tk])return;
                var price=null;
                if(s.lastTrade&&s.lastTrade.p) price=s.lastTrade.p;
                else if(s.min&&s.min.c) price=s.min.c;
                else if(s.day&&s.day.c) price=s.day.c;
                else if(s.prevDay&&s.prevDay.c) price=s.prevDay.c;
                if(!price)return;
                if(s.prevDay&&s.prevDay.c) prevCloses[tk]=s.prevDay.c;
                prices[tk]={price:price,change:s.todaysChangePerc||0,ts:s.updated||Date.now()};
                updateMW(tk);loaded++;
            });
            console.log('[Polygon] Crypto:',cryptoSnap.tickers.length,'tokens cargados');
        }else{
            await loadFallback(cryptoTickers);loaded+=cryptoTickers.length;
        }
    }else{
        console.log('[Polygon] Crypto: snapshot omitido (plan), usando aggregates...');
        await loadFallbackAgg(cryptoTickers);loaded+=cryptoTickers.length;
    }

    console.log('[Polygon] Total cargados:',loaded,'/',TICKERS.length,'| API calls:',apiCalls,'| Errores:',apiErrors);
    return loaded;
}

/* ‚îÄ‚îÄ Fallback: individual REST calls if snapshot fails ‚îÄ‚îÄ */
async function loadFallback(tickers){
    // First load prev closes
    await Promise.allSettled(tickers.map(function(t){
        return api('/v2/aggs/ticker/'+t+'/prev?adjusted=true').then(function(d){
            if(d&&d.results&&d.results.length) prevCloses[t]=d.results[0].c;
        });
    }));
    // Then load current prices
    await Promise.allSettled(tickers.map(function(t){
        return getPrice(t).then(function(r){
            if(r){prices[t]=r;updateMW(t);}
        });
    }));
}

/* ‚îÄ‚îÄ Fallback: aggregates only (for markets without snapshot access) ‚îÄ‚îÄ */
async function loadFallbackAgg(tickers){
    await Promise.allSettled(tickers.map(function(t){
        return api('/v2/aggs/ticker/'+t+'/prev?adjusted=true').then(function(d){
            if(d&&d.results&&d.results.length) prevCloses[t]=d.results[0].c;
        });
    }));
    await Promise.allSettled(tickers.map(function(t){
        return getPrice(t).then(function(r){
            if(r){prices[t]=r;updateMW(t);}
        });
    }));
}

async function getPrice(ticker){
    // Try snapshot for single ticker first (only if plan allows)
    var a=ASSETS[ticker];if(!a)return null;
    var market=a.ws==='stocks'?'stocks':a.ws;
    var locale=a.ws==='stocks'?'us':'global';
    var mkt=a.ws==='stocks'?'stocks':a.ws==='forex'?'forex':'crypto';

    if(PLAN.snapEnabled[mkt]){
        var snap=await api('/v2/snapshot/locale/'+locale+'/markets/'+mkt+'/tickers/'+ticker);
        if(snap&&snap.ticker){
            var s=snap.ticker;
            var price=null;
            if(mkt==='forex'&&s.lastQuote) price=(s.lastQuote.a+s.lastQuote.b)/2;
            else if(s.lastTrade&&s.lastTrade.p) price=s.lastTrade.p;
            else if(s.min&&s.min.c) price=s.min.c;
            else if(s.day&&s.day.c) price=s.day.c;
            if(price){
                if(s.prevDay&&s.prevDay.c) prevCloses[ticker]=s.prevDay.c;
                return{price:price,change:s.todaysChangePerc||0,ts:s.updated||Date.now()};
            }
        }
    }

    // Fallback to aggregates
    var d=await api('/v2/aggs/ticker/'+ticker+'/range/1/minute/'+ago(2)+'/'+today()+'?sort=desc&limit=5&adjusted=true');
    if(d&&d.results&&d.results.length){
        var l=d.results[0],pc=prevCloses[ticker]||l.o;
        return{price:l.c,change:pc?((l.c-pc)/pc*100):0,ts:l.t};
    }
    var pv=await api('/v2/aggs/ticker/'+ticker+'/prev?adjusted=true');
    if(pv&&pv.results&&pv.results.length){
        var r=pv.results[0];prevCloses[ticker]=r.c;
        return{price:r.c,change:((r.c-r.o)/r.o*100),ts:r.t};
    }
    return null;
}

async function getCandles(ticker,mul,span){
    var from;
    if(span==='minute') from=mul<=1?ago(2):mul<=5?ago(7):ago(14);
    else if(span==='hour') from=ago(90);
    else if(span==='day') from=ago(365);
    else from=ago(730);
    var d=await api('/v2/aggs/ticker/'+ticker+'/range/'+mul+'/'+span+'/'+from+'/'+today()+'?adjusted=true&sort=asc&limit=5000');
    if(d&&d.results&&d.results.length) return d.results;
    return[];
}

/* ‚îÄ‚îÄ REST polling fallback (rotates through markets) ‚îÄ‚îÄ */
var pollIdx=0;
function pollREST(){
    var markets=['crypto','forex','stocks'];
    var m=markets[pollIdx%3];pollIdx++;
    if(PLAN.wsEnabled[m]&&wsAlive[m]) return; // WS is live for this market, skip
    var tks=TICKERS.filter(function(t){return ASSETS[t].ws===m;});
    tks.forEach(function(t){
        getPrice(t).then(function(r){
            if(r){prices[t]=r;updateMW(t);updateSlots(t);}
        });
    });
}

/* ‚ïê‚ïê‚ïê WEBSOCKET (Real-time Polygon streams) ‚ïê‚ïê‚ïê */
function connectAllWS(){['crypto','forex','stocks'].forEach(function(m){
    if(PLAN.wsEnabled[m]) connectWS(m);
    else console.log('[WS] '+m+' omitido (plan no incluye WS para '+m+')');
});}
function connectWS(market){
    if(wsConns[market])try{wsConns[market].close();}catch(e){}
    var ws;try{ws=new WebSocket(WS_URLS[market]);}catch(e){console.warn('[WS] No se pudo conectar a',market);return;}
    wsConns[market]=ws;
    ws.onopen=function(){
        console.log('[WS] Conectado a',market,'‚Äî autenticando...');
        ws.send(JSON.stringify({action:'auth',params:API_KEY}));
    };
    ws.onmessage=function(e){
        var msgs;try{msgs=JSON.parse(e.data);}catch(err){return;}
        if(!Array.isArray(msgs))msgs=[msgs];
        msgs.forEach(function(msg){
            if(msg.ev==='status'){
                if(msg.status==='auth_success'){
                    wsAlive[market]=true;updWS();subMkt(ws,market);
                    console.log('[WS] ‚úì',market,'autenticado y suscrito');
                }else if(msg.status==='auth_failed'){
                    console.error('[WS] ‚úó Auth fallida en',market,msg.message||'');
                }
                return;
            }
            handleWS(msg);
        });
    };
    ws.onclose=function(ev){
        wsAlive[market]=false;updWS();
        console.warn('[WS]',market,'desconectado (code:'+ev.code+'). Reconectando en 5s...');
        setTimeout(function(){connectWS(market);},5000);
    };
    ws.onerror=function(){wsAlive[market]=false;updWS();};
}
function subMkt(ws,m){
    var tks=TICKERS.filter(function(t){return ASSETS[t].ws===m;}),ch;
    if(m==='crypto')ch=tks.map(function(t){return'XT.'+t+',XA.'+t;}).join(',');
    else if(m==='forex')ch=tks.map(function(t){return'C.'+t+',CA.'+t;}).join(',');
    else ch=tks.map(function(t){return'AM.'+t+',T.'+t;}).join(',');
    if(ch)ws.send(JSON.stringify({action:'subscribe',params:ch}));
}
function handleWS(msg){
    var tk=null,p=null;
    // Crypto
    if(msg.ev==='XT'){tk=msg.pair;p=msg.p;}
    else if(msg.ev==='XA'){tk=msg.pair;p=msg.c;}
    // Forex
    else if(msg.ev==='C'){tk=msg.p;p=msg.a&&msg.b?(msg.a+msg.b)/2:null;}
    else if(msg.ev==='CA'){tk=msg.pair;p=msg.c;}
    // Stocks
    else if(msg.ev==='AM'){tk=msg.sym;p=msg.c;}
    else if(msg.ev==='T'){tk=msg.sym;p=msg.p;}
    if(!tk||!p||!ASSETS[tk])return;
    // Throttle: max 1 update per 200ms per ticker
    var now=Date.now();if(wsThrottle[tk]&&now-wsThrottle[tk]<200)return;wsThrottle[tk]=now;
    // Calculate change vs previous close
    var pc=prevCloses[tk]||(prices[tk]?prices[tk].price:p);
    prices[tk]={price:p,change:pc?((p-pc)/pc*100):0,ts:now};
    updateMW(tk);updateSlots(tk);
}
function updWS(){
    var alive=0;['crypto','forex','stocks'].forEach(function(m){if(wsAlive[m])alive++;});
    var d=$('ws-dot'),l=$('ws-lbl');
    if(alive===3){d.className='size-2 rounded-full bg-green-500 live-p';l.textContent='LIVE';l.className='text-[9px] font-mono text-green-500 font-bold';}
    else if(alive>0){d.className='size-2 rounded-full bg-yellow-500 live-p';l.textContent='WS '+alive+'/3';l.className='text-[9px] font-mono text-yellow-500';}
    else{d.className='size-2 rounded-full bg-gray-400 animate-pulse';l.textContent='REST';l.className='text-[9px] font-mono text-gray-400';}
}

/* ‚ïê‚ïê‚ïê MARKET WATCH / LISTA DE SEGUIMIENTO ‚ïê‚ïê‚ïê */
function buildMW(){
    var box=$('mw-list');box.innerHTML='';
    TICKERS.forEach(function(tk){
        var a=ASSETS[tk];
        var row=document.createElement('div');
        row.className='mw-row flex items-center px-3 py-[7px] border-b border-card-border/30';
        row.dataset.ticker=tk;row.dataset.cat=a.cat;
        row.dataset.search=(a.label+' '+a.sub+' '+a.abbr+' '+tk).toLowerCase();
        row.innerHTML=
            '<div class="flex items-center gap-2 flex-1 min-w-0">'+
                '<div class="size-[26px] rounded-lg flex items-center justify-center text-[8px] font-bold shrink-0" style="background:'+a.color+'18;color:'+a.color+';border:1px solid '+a.color+'25">'+a.abbr+'</div>'+
                '<div class="min-w-0">'+
                    '<div class="text-[11px] font-bold text-white truncate">'+a.label+'</div>'+
                    '<div class="text-[9px] text-gray-500 truncate">'+a.sub+'</div>'+
                '</div>'+
            '</div>'+
            '<div class="text-right shrink-0">'+
                '<div class="mw-price text-[11px] font-mono font-semibold text-white">‚Äî</div>'+
                '<div class="mw-chg text-[9px] font-bold text-gray-500">‚Äî</div>'+
            '</div>';
        row.addEventListener('click',function(){openChart(tk);});
        box.appendChild(row);
    });
}
function updateMW(tk){
    var d=prices[tk];if(!d)return;
    var row=document.querySelector('.mw-row[data-ticker="'+tk+'"]');if(!row)return;
    var pEl=row.querySelector('.mw-price'),cEl=row.querySelector('.mw-chg');
    if(pEl){
        var nv=fmt(d.price,tk);
        if(pEl.textContent!==nv){
            var old=prevPrices[tk];pEl.textContent=nv;
            if(old!=null&&old!==d.price){row.classList.remove('fl-up','fl-dn');void row.offsetWidth;row.classList.add(d.price>old?'fl-up':'fl-dn');}
            prevPrices[tk]=d.price;
        }
    }
    if(cEl){var pos=d.change>=0;cEl.textContent=(pos?'+':'')+d.change.toFixed(2)+'%';cEl.className='mw-chg text-[9px] font-bold '+(pos?'text-green-500':'text-red-500');}
}
function filterMW(){
    var search=currentMWSearch.toLowerCase();
    $$('.mw-row').forEach(function(r){
        var catMatch=(currentCat==='all'||r.dataset.cat===currentCat);
        var searchMatch=(!search||r.dataset.search.indexOf(search)>=0);
        r.style.display=(catMatch&&searchMatch)?'':'none';
    });
}

/* ‚ïê‚ïê‚ïê GLOBAL SEARCH (disabled - search removed from header) ‚ïê‚ïê‚ïê */
function initGlobalSearch(){}
function showSearchResults(){}

/* ‚ïê‚ïê‚ïê CHART SLOTS ‚ïê‚ïê‚ïê */
function createLWChart(container){
    return LightweightCharts.createChart(container,{
        width:container.clientWidth,height:container.clientHeight,
        layout:{background:{type:'solid',color:'#0a0f1a'},textColor:'#9ca3af',fontFamily:'JetBrains Mono, monospace',fontSize:9},
        grid:{vertLines:{color:'rgba(31,41,55,0.5)'},horzLines:{color:'rgba(31,41,55,0.5)'}},
        crosshair:{mode:LightweightCharts.CrosshairMode.Normal,vertLine:{color:'rgba(212,175,55,0.2)',width:1,style:2,labelBackgroundColor:'#D4AF37'},horzLine:{color:'rgba(212,175,55,0.2)',width:1,style:2,labelBackgroundColor:'#D4AF37'}},
        rightPriceScale:{borderColor:'#1f2937',scaleMargins:{top:0.15,bottom:0.18},minimumWidth:60},
        timeScale:{borderColor:'#1f2937',timeVisible:true,secondsVisible:false,rightOffset:4,barSpacing:4,minBarSpacing:1},
        handleScroll:{vertTouchDrag:false}
    });
}

async function openChart(ticker){
    for(var i=0;i<4;i++){if(slots[i]&&slots[i].ticker===ticker){focusSlot(i);return;}}
    var idx=-1;
    for(var i=0;i<4;i++){if(!slots[i]){idx=i;break;}}
    if(idx===-1){idx=focusedSlot;closeSlot(idx);}

    var a=ASSETS[ticker];
    var el=$('slot-'+idx);
    var empty=el.querySelector('.slot-empty');if(empty)empty.style.display='none';

    el.querySelector('.slot-icon').style.background=a.color+'18';
    el.querySelector('.slot-icon').style.color=a.color;
    el.querySelector('.slot-icon').style.border='1px solid '+a.color+'30';
    el.querySelector('.slot-icon').textContent=a.abbr;
    el.querySelector('.slot-label').textContent=a.label;
    el.querySelector('.slot-label').className='slot-label text-[11px] font-bold text-white';

    var box=el.querySelector('.slot-chart');
    var lw=createLWChart(box);
    var cs=lw.addCandlestickSeries({upColor:'#22c55e',downColor:'#ef4444',borderUpColor:'#22c55e',borderDownColor:'#ef4444',wickUpColor:'#22c55e99',wickDownColor:'#ef444499'});
    var vs=lw.addHistogramSeries({priceFormat:{type:'volume'},priceScaleId:'vol_'+idx});
    lw.priceScale('vol_'+idx).applyOptions({scaleMargins:{top:0.92,bottom:0}});
    var es=lw.addLineSeries({color:'#D4AF37',lineWidth:1.5,lineStyle:0,priceLineVisible:false,lastValueVisible:false,crosshairMarkerVisible:false});

    new ResizeObserver(function(){lw.applyOptions({width:box.clientWidth,height:box.clientHeight});}).observe(box);

    slots[idx]={ticker:ticker,chart:lw,candleSeries:cs,volumeSeries:vs,emaSeries:es,candles:null,tf:{mul:1,span:'hour'},drawings:[],markers:[],_emaVisible:true,_volVisible:true};
    // Subscribe to click for drawing tools
    (function(i){
        lw.subscribeClick(function(param){handleChartClick(param,i);});
    })(idx);
    focusSlot(idx);
    buildTabs();
    updateAI(ticker);

    var raw=await getCandles(ticker,1,'hour');
    if(raw.length){slots[idx].candles=raw;renderSlotCandles(idx,raw);}
    if(prices[ticker]) updateSlotHeader(idx);
}

function renderSlotCandles(idx,raw){
    var s=slots[idx];if(!s)return;
    var cd=[],vd=[],seen={};
    for(var i=0;i<raw.length;i++){
        var c=raw[i],t=Math.floor(c.t/1000);if(seen[t])continue;seen[t]=true;
        var rng=c.o?(c.h-c.l)/c.o:0;if(rng>0.05&&i>0)c={t:c.t,o:c.o,h:Math.max(c.o,c.c)*1.002,l:Math.min(c.o,c.c)*0.998,c:c.c,v:c.v};
        cd.push({time:t,open:c.o,high:c.h,low:c.l,close:c.c});
        vd.push({time:t,value:c.v||0,color:c.c>=c.o?'rgba(34,197,94,0.06)':'rgba(239,68,68,0.06)'});
    }
    try{s.candleSeries.setData(cd);s.volumeSeries.setData(vd);s.emaSeries.setData(calcEMA(cd,20));
    if(cd.length>150) s.chart.timeScale().setVisibleLogicalRange({from:cd.length-150,to:cd.length+4});
    else s.chart.timeScale().fitContent();
    s.chart.timeScale().scrollToRealTime();}catch(e){}

    if(idx===focusedSlot&&cd.length>14){
        var rsiVal=calcRSI(cd,14);
        updateAIIndicators(s.ticker,rsiVal);
    }
}

function closeSlot(idx){
    var s=slots[idx];if(!s)return;
    try{s.chart.remove();}catch(e){}slots[idx]=null;
    var el=$('slot-'+idx);
    el.querySelector('.slot-chart').innerHTML='';
    el.querySelector('.slot-icon').style.background='';el.querySelector('.slot-icon').style.color='';el.querySelector('.slot-icon').style.border='';el.querySelector('.slot-icon').textContent='‚Äî';
    el.querySelector('.slot-label').textContent='Vac√≠o';el.querySelector('.slot-label').className='slot-label text-[11px] font-bold text-gray-400';
    el.querySelector('.slot-price').textContent='‚Äî';el.querySelector('.slot-price').className='slot-price text-[12px] font-mono font-semibold text-gray-400';
    el.querySelector('.slot-change').textContent='‚Äî';el.querySelector('.slot-change').className='slot-change text-[9px] font-bold px-1.5 py-0.5 rounded text-gray-400';
    var empty=el.querySelector('.slot-empty');if(empty)empty.style.display='';
    el.classList.remove('focused');
    buildTabs();
}

function focusSlot(idx){
    focusedSlot=idx;
    $$('.chart-slot').forEach(function(el,i){el.classList.toggle('focused',i===idx);});
    $$('.chart-tab').forEach(function(t){t.classList.toggle('active',parseInt(t.dataset.idx)===idx);});
    $$('.mw-row').forEach(function(r){r.classList.remove('sel');});
    if(slots[idx]){
        var row=document.querySelector('.mw-row[data-ticker="'+slots[idx].ticker+'"]');
        if(row)row.classList.add('sel');
        updateAI(slots[idx].ticker);
    }
}

function updateSlotHeader(idx){
    var s=slots[idx];if(!s)return;
    var d=prices[s.ticker];if(!d)return;
    var el=$('slot-'+idx);
    var pEl=el.querySelector('.slot-price'),cEl=el.querySelector('.slot-change');
    var pos=d.change>=0;
    pEl.textContent=fmt(d.price,s.ticker);pEl.className='slot-price text-[12px] font-mono font-semibold '+(pos?'text-green-500':'text-red-500');
    cEl.textContent=(pos?'+':'')+d.change.toFixed(2)+'%';cEl.className='slot-change text-[9px] font-bold px-1.5 py-0.5 rounded '+(pos?'text-green-500 bg-green-500/10':'text-red-500 bg-red-500/10');
}

function updateSlots(ticker){
    for(var i=0;i<4;i++){
        var s=slots[i];if(!s||s.ticker!==ticker)continue;
        updateSlotHeader(i);
        var d=prices[ticker];if(!d||!s.candles||!s.candles.length)continue;
        var lc=s.candles[s.candles.length-1],np=d.price,tm=Math.floor(lc.t/1000);
        if(lc.o&&Math.abs(np-lc.o)/lc.o<0.03){
            try{s.candleSeries.update({time:tm,open:lc.o,high:Math.max(lc.h,np),low:Math.min(lc.l,np),close:np});
            s.volumeSeries.update({time:tm,value:lc.v||0,color:np>=lc.o?'rgba(34,197,94,0.06)':'rgba(239,68,68,0.06)'});}catch(e){}
        }
    }
}

function calcEMA(d,p){if(d.length<p)return[];var k=2/(p+1),r=[],s=0;for(var i=0;i<p;i++)s+=d[i].close;var pv=s/p;r.push({time:d[p-1].time,value:pv});for(var j=p;j<d.length;j++){var v=d[j].close*k+pv*(1-k);r.push({time:d[j].time,value:v});pv=v;}return r;}

function calcRSI(data,period){
    if(data.length<period+1)return 50;
    var gains=0,losses=0;
    for(var i=data.length-period;i<data.length;i++){
        var diff=data[i].close-data[i-1].close;
        if(diff>0)gains+=diff;else losses-=diff;
    }
    var avgGain=gains/period,avgLoss=losses/period;
    if(avgLoss===0)return 100;
    var rs=avgGain/avgLoss;
    return 100-(100/(1+rs));
}

/* ‚ïê‚ïê‚ïê AMIGOTRADE AI ‚ïê‚ïê‚ïê */
function updateAI(ticker){
    var a=ASSETS[ticker];if(!a)return;
    var d=prices[ticker];
    var badge=$('ai-badge'),pattern=$('ai-pattern'),desc=$('ai-desc');

    if(!d){
        badge.className='badge-neutral text-[8px] font-bold px-2 py-0.5 rounded-full';badge.textContent='CARGANDO';
        pattern.textContent='Analizando '+a.label+'...';
        desc.textContent='Obteniendo datos del mercado...';
        return;
    }

    var chg=d.change;
    if(chg>0.3){
        badge.className='badge-alcista text-[8px] font-bold px-2 py-0.5 rounded-full';badge.textContent='ALCISTA';
        pattern.textContent='Tendencia Alcista';
        desc.textContent='Momentum positivo en '+a.label+'. Movimiento de +'+chg.toFixed(2)+'% en la sesi√≥n. Vigilar resistencias pr√≥ximas.';
    }else if(chg<-0.3){
        badge.className='badge-bajista text-[8px] font-bold px-2 py-0.5 rounded-full';badge.textContent='BAJISTA';
        pattern.textContent='Presi√≥n Bajista';
        desc.textContent='Correcci√≥n activa en '+a.label+'. Ca√≠da de '+Math.abs(chg).toFixed(2)+'% en la sesi√≥n. Buscar soportes clave.';
    }else{
        badge.className='badge-neutral text-[8px] font-bold px-2 py-0.5 rounded-full';badge.textContent='NEUTRAL';
        pattern.textContent='Consolidaci√≥n';
        desc.textContent=a.label+' se mueve en rango estrecho ('+chg.toFixed(2)+'%). Esperar confirmaci√≥n de direcci√≥n.';
    }
}
function updateAIIndicators(ticker,rsiVal){
    var rsiEl=$('ai-rsi'),rsiLabel=$('ai-rsi-label'),rsiBar=$('ai-rsi-bar');
    rsiEl.textContent=rsiVal.toFixed(1);
    rsiBar.style.width=rsiVal+'%';
    if(rsiVal<30){
        rsiLabel.textContent='Sobrevendido';rsiLabel.className='text-[9px] font-bold text-green-500';
        rsiBar.className='h-full rounded-full bg-green-500 transition-all duration-500';
    }else if(rsiVal>70){
        rsiLabel.textContent='Sobrecomprado';rsiLabel.className='text-[9px] font-bold text-red-500';
        rsiBar.className='h-full rounded-full bg-red-500 transition-all duration-500';
    }else{
        rsiLabel.textContent='Neutral';rsiLabel.className='text-[9px] font-bold text-gray-400';
        rsiBar.className='h-full rounded-full bg-primary transition-all duration-500';
    }
}

/* ‚îÄ‚îÄ‚îÄ TIMEFRAME BUTTONS ‚îÄ‚îÄ‚îÄ */
function initTFButtons(){
    for(var i=0;i<4;i++){
        (function(idx){
            var el=$('slot-'+idx);
            el.querySelectorAll('.slot-tf-btn').forEach(function(btn){
                btn.addEventListener('click',function(e){
                    e.stopPropagation();
                    var s=slots[idx];if(!s)return;
                    el.querySelectorAll('.slot-tf-btn').forEach(function(b){b.className='slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded text-gray-400 hover:text-primary hover:bg-primary/10 transition';});
                    this.className='slot-tf-btn text-[9px] font-mono px-1.5 py-0.5 rounded bg-primary/10 text-primary font-bold';
                    var tf=this.dataset.tf.split('-');
                    var mul=parseInt(tf[0]),span=tf[1];
                    s.tf={mul:mul,span:span};
                    getCandles(s.ticker,mul,span).then(function(raw){
                        if(raw.length){s.candles=raw;renderSlotCandles(idx,raw);}
                    });
                });
            });
        })(i);
    }
}

/* ‚îÄ‚îÄ‚îÄ BOTTOM TABS ‚îÄ‚îÄ‚îÄ */
function buildTabs(){
    var box=$('bottom-tabs');
    box.innerHTML='<span class="text-[8px] text-gray-500 font-mono px-2 shrink-0">Gr√°ficos:</span>';
    for(var i=0;i<4;i++){
        var s=slots[i];if(!s)continue;
        var a=ASSETS[s.ticker];
        var tab=document.createElement('div');
        tab.className='chart-tab flex items-center gap-1.5 px-3 py-1 rounded-t'+(i===focusedSlot?' active':'');
        tab.dataset.idx=i;
        tab.innerHTML=
            '<div class="size-4 rounded flex items-center justify-center text-[6px] font-bold" style="background:'+a.color+'18;color:'+a.color+'">'+a.abbr+'</div>'+
            '<span class="text-[10px] font-bold text-white">'+a.label+'</span>'+
            '<button class="tab-x ml-1 text-gray-500 hover:text-red-500 transition text-[10px] leading-none" title="Cerrar">‚úï</button>';
        tab.addEventListener('click',function(ev){
            if(ev.target.closest('.tab-x')){closeSlot(parseInt(this.dataset.idx));return;}
            focusSlot(parseInt(this.dataset.idx));
        });
        box.appendChild(tab);
    }
}

/* ‚îÄ‚îÄ‚îÄ ORDER TABS ‚îÄ‚îÄ‚îÄ */
function initOrderTabs(){
    $$('.order-tab').forEach(function(tab){
        tab.addEventListener('click',function(){
            $$('.order-tab').forEach(function(t){t.classList.remove('active');});
            this.classList.add('active');
        });
    });
}

/* ‚îÄ‚îÄ‚îÄ LEFT TOOLBAR / DRAWING TOOLS ‚îÄ‚îÄ‚îÄ */
var activeTool='cursor';
var drawState={clicks:[],pendingSeries:null};

function showToast(msg,gold){
    var t=$('toast');t.textContent=msg;t.className='toast show'+(gold?' gold':'');
    clearTimeout(t._tid);t._tid=setTimeout(function(){t.className='toast';},2200);
}

function setTool(tool){
    // Instant actions (no mode switch)
    if(tool==='screenshot'){screenshotChart();return;}
    if(tool==='delete'){deleteDrawings();return;}
    if(tool==='toggleEMA'){toggleEMA();return;}
    if(tool==='toggleVol'){toggleVolume();return;}

    activeTool=tool;drawState.clicks=[];
    $$('.tool-btn').forEach(function(b){b.classList.remove('active');});
    var btn=document.querySelector('.tool-btn[data-tool="'+tool+'"]');
    if(btn)btn.classList.add('active');

    // Toggle crosshair cursor on all chart slots
    $$('.chart-slot').forEach(function(el){
        el.classList.toggle('drawing-mode',tool!=='cursor');
    });

    if(tool==='cursor') showToast('Modo cursor');
    else if(tool==='hline') showToast('Click en el gr√°fico para l√≠nea horizontal',true);
    else if(tool==='trendline') showToast('Click en 2 puntos para l√≠nea de tendencia',true);
    else if(tool==='fibonacci') showToast('Click en 2 puntos para Fibonacci',true);
    else if(tool==='marker') showToast('Click en el gr√°fico para agregar marcador',true);
    else if(tool==='measure') showToast('Click en 2 puntos para medir',true);
}

function initToolbar(){
    $$('.tool-btn').forEach(function(btn){
        btn.addEventListener('click',function(){
            var tool=this.dataset.tool;
            if(tool) setTool(tool);
        });
    });
    // ESC key returns to cursor
    document.addEventListener('keydown',function(e){
        if(e.key==='Escape'){setTool('cursor');}
        // Shortcut keys
        if(e.key==='h'&&!e.ctrlKey&&!e.metaKey&&document.activeElement.tagName!=='INPUT') setTool('hline');
        if(e.key==='t'&&!e.ctrlKey&&!e.metaKey&&document.activeElement.tagName!=='INPUT') setTool('trendline');
        if(e.key==='f'&&!e.ctrlKey&&!e.metaKey&&document.activeElement.tagName!=='INPUT') setTool('fibonacci');
        if(e.key==='m'&&!e.ctrlKey&&!e.metaKey&&document.activeElement.tagName!=='INPUT') setTool('marker');
        if(e.key==='Delete'||e.key==='Backspace'&&document.activeElement.tagName!=='INPUT') deleteDrawings();
    });
}

/* ‚îÄ‚îÄ‚îÄ CHART CLICK HANDLER FOR DRAWING ‚îÄ‚îÄ‚îÄ */
function handleChartClick(param,idx){
    if(activeTool==='cursor'||!param.time||!param.point) return;
    var s=slots[idx];if(!s) return;
    // Get price from click
    var price=s.candleSeries.coordinateToPrice(param.point.y);
    var time=param.time;
    if(!price||!time) return;

    if(!s.drawings) s.drawings=[];
    if(!s.markers) s.markers=[];

    if(activeTool==='hline'){
        addHLine(s,price);
        showToast('L√≠nea en '+price.toFixed(ASSETS[s.ticker].d));
        setTool('cursor');
    }
    else if(activeTool==='marker'){
        addMarker(s,time,price);
        showToast('Marcador agregado');
        setTool('cursor');
    }
    else if(activeTool==='trendline'){
        drawState.clicks.push({time:time,price:price});
        if(drawState.clicks.length===1){
            showToast('Punto 1 ‚úì ‚Äî click en punto 2',true);
        }else if(drawState.clicks.length>=2){
            addTrendLine(s,drawState.clicks[0],drawState.clicks[1]);
            showToast('L√≠nea de tendencia dibujada');
            drawState.clicks=[];
            setTool('cursor');
        }
    }
    else if(activeTool==='fibonacci'){
        drawState.clicks.push({time:time,price:price});
        if(drawState.clicks.length===1){
            showToast('Punto 1 ‚úì ‚Äî click en punto 2',true);
        }else if(drawState.clicks.length>=2){
            addFibonacci(s,drawState.clicks[0],drawState.clicks[1]);
            showToast('Fibonacci dibujado');
            drawState.clicks=[];
            setTool('cursor');
        }
    }
    else if(activeTool==='measure'){
        drawState.clicks.push({time:time,price:price});
        if(drawState.clicks.length===1){
            showToast('Punto 1 ‚úì ‚Äî click en punto 2',true);
        }else if(drawState.clicks.length>=2){
            showMeasure(s,drawState.clicks[0],drawState.clicks[1]);
            drawState.clicks=[];
            setTool('cursor');
        }
    }
}

/* ‚îÄ‚îÄ‚îÄ DRAWING IMPLEMENTATIONS ‚îÄ‚îÄ‚îÄ */
function addHLine(s,price){
    var line=s.candleSeries.createPriceLine({
        price:price,
        color:'#D4AF37',
        lineWidth:1,
        lineStyle:LightweightCharts.LineStyle.Dashed,
        axisLabelVisible:true,
        title:price.toFixed(ASSETS[s.ticker].d)
    });
    s.drawings.push({type:'hline',obj:line});
}

function addTrendLine(s,p1,p2){
    var ls=s.chart.addLineSeries({
        color:'#3b82f6',lineWidth:2,
        crosshairMarkerVisible:false,lastValueVisible:false,priceLineVisible:false
    });
    ls.setData([
        {time:p1.time,value:p1.price},
        {time:p2.time,value:p2.price}
    ]);
    s.drawings.push({type:'trendline',obj:ls});
}

function addFibonacci(s,p1,p2){
    var hi=Math.max(p1.price,p2.price),lo=Math.min(p1.price,p2.price);
    var diff=hi-lo;
    var levels=[
        {r:0,   c:'#9ca3af'},
        {r:0.236,c:'#22c55e'},
        {r:0.382,c:'#eab308'},
        {r:0.5,  c:'#D4AF37'},
        {r:0.618,c:'#f97316'},
        {r:0.786,c:'#ef4444'},
        {r:1,   c:'#9ca3af'}
    ];
    var fibLines=[];
    levels.forEach(function(lv){
        var pr=hi-diff*lv.r;
        var line=s.candleSeries.createPriceLine({
            price:pr,color:lv.c,lineWidth:1,
            lineStyle:LightweightCharts.LineStyle.Dotted,
            axisLabelVisible:true,
            title:(lv.r*100).toFixed(1)+'%'
        });
        fibLines.push(line);
    });
    s.drawings.push({type:'fibonacci',obj:fibLines});
}

function addMarker(s,time,price){
    s.markers.push({
        time:time,
        position:'aboveBar',
        color:'#D4AF37',
        shape:'arrowDown',
        text:'üìå '+price.toFixed(ASSETS[s.ticker].d)
    });
    // Sort markers by time (required by LW)
    s.markers.sort(function(a,b){return a.time-b.time;});
    s.candleSeries.setMarkers(s.markers);
    s.drawings.push({type:'marker',obj:null});
}

function showMeasure(s,p1,p2){
    var dec=ASSETS[s.ticker].d;
    var diff=p2.price-p1.price;
    var pct=p1.price?((diff/p1.price)*100):0;
    var pips=Math.abs(diff);
    var sign=diff>=0?'+':'';
    var color=diff>=0?'#22c55e':'#ef4444';
    var msg=sign+diff.toFixed(dec)+' ('+sign+pct.toFixed(2)+'%)';
    showToast('üìè Œî '+msg,false);

    // Also draw a temporary line between the 2 points
    var ls=s.chart.addLineSeries({
        color:color,lineWidth:1,lineStyle:LightweightCharts.LineStyle.LargeDashed,
        crosshairMarkerVisible:false,lastValueVisible:false,priceLineVisible:false
    });
    ls.setData([
        {time:p1.time,value:p1.price},
        {time:p2.time,value:p2.price}
    ]);
    s.drawings.push({type:'measure',obj:ls});
}

function deleteDrawings(){
    var s=slots[focusedSlot];if(!s)return;
    if(!s.drawings||!s.drawings.length){showToast('No hay dibujos que borrar');return;}
    s.drawings.forEach(function(d){
        if(d.type==='hline') try{s.candleSeries.removePriceLine(d.obj);}catch(e){}
        else if(d.type==='fibonacci'){d.obj.forEach(function(l){try{s.candleSeries.removePriceLine(l);}catch(e){}});}
        else if(d.type==='trendline'||d.type==='measure') try{s.chart.removeSeries(d.obj);}catch(e){}
    });
    s.drawings=[];
    s.markers=[];
    try{s.candleSeries.setMarkers([]);}catch(e){}
    showToast('Dibujos eliminados ‚úì');
}

function screenshotChart(){
    var s=slots[focusedSlot];if(!s){showToast('Selecciona un gr√°fico primero');return;}
    try{
        var canvas=s.chart.takeScreenshot();
        canvas.toBlob(function(blob){
            if(!blob){showToast('Error al capturar');return;}
            var item=new ClipboardItem({'image/png':blob});
            navigator.clipboard.write([item]).then(function(){
                showToast('üì∑ Captura copiada al portapapeles ‚úì',true);
            }).catch(function(){
                // Fallback: download
                var url=URL.createObjectURL(blob);
                var a=document.createElement('a');
                a.href=url;a.download=ASSETS[s.ticker].label+'_chart.png';
                a.click();URL.revokeObjectURL(url);
                showToast('üì∑ Captura descargada ‚úì',true);
            });
        });
    }catch(e){showToast('Error al capturar');}
}

function toggleEMA(){
    var s=slots[focusedSlot];if(!s)return;
    if(!s._emaVisible) s._emaVisible=true;
    else s._emaVisible=!s._emaVisible;
    // Toggle by setting line to transparent or gold
    s.emaSeries.applyOptions({color:s._emaVisible?'#D4AF37':'transparent'});
    var btn=document.querySelector('.tool-btn[data-tool="toggleEMA"]');
    btn.classList.toggle('active',s._emaVisible);
    showToast('EMA 20: '+(s._emaVisible?'Visible':'Oculta'));
}
function toggleVolume(){
    var s=slots[focusedSlot];if(!s)return;
    if(s._volVisible===undefined) s._volVisible=true;
    s._volVisible=!s._volVisible;
    s.chart.priceScale('vol_'+focusedSlot).applyOptions({scaleMargins:{top:s._volVisible?0.92:1,bottom:0}});
    var btn=document.querySelector('.tool-btn[data-tool="toggleVol"]');
    btn.classList.toggle('active',s._volVisible);
    showToast('Volumen: '+(s._volVisible?'Visible':'Oculto'));
}

/* ‚îÄ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ‚îÄ */
$$('.cat-btn').forEach(function(b){b.addEventListener('click',function(){
    currentCat=b.dataset.cat;
    $$('.cat-btn').forEach(function(x){x.classList.remove('act');});
    b.classList.add('act');
    filterMW();
});});

$('mw-search').addEventListener('input',function(){currentMWSearch=this.value;filterMW();});

for(var i=0;i<4;i++){
    (function(idx){
        $('slot-'+idx).querySelector('.slot-close').addEventListener('click',function(e){e.stopPropagation();closeSlot(idx);});
        $('slot-'+idx).addEventListener('click',function(){if(slots[idx])focusSlot(idx);});
    })(i);
}

/* ‚ïê‚ïê‚ïê TICKER TAPE ‚ïê‚ïê‚ïê */
function renderTickerTape(){
    var c=document.getElementById('ticker-tape');if(!c)return;
    var h='';
    TICKERS.forEach(function(tk){
        var a=ASSETS[tk];if(!a)return;
        var d=prices[tk];if(!d)return;
        var pc=prevCloses[tk]||d.price;
        var chg=pc?((d.price-pc)/pc*100):0;
        var col=chg>=0?'text-green-500':'text-red-500';
        var arr=chg>=0?'‚ñ≤':'‚ñº';
        var dd=a.d||2;
        var pf=dd>2?d.price.toFixed(dd):d.price.toLocaleString('en-US',{minimumFractionDigits:dd,maximumFractionDigits:dd});
        h+='<span class="mx-6 flex items-center gap-2"><span class="text-white font-medium">'+a.label+'</span><span class="text-gray-300 font-mono">'+pf+'</span><span class="'+col+' text-xs">'+arr+' '+Math.abs(chg).toFixed(2)+'%</span></span>';
    });
    c.innerHTML=h+h;
}

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
async function init(){
    console.log('[InvertProfit] Iniciando terminal...');
    console.log('[Polygon] API Key:',API_KEY.slice(0,8)+'...','| Tickers:',TICKERS.length);
    buildMW();
    initGlobalSearch();
    initTFButtons();
    initOrderTabs();
    initToolbar();

    // Load all prices via Polygon Snapshots (3 API calls)
    var ok=await loadSnapshots();

    if(ok){
        renderTickerTape();
        var defaults=['X:BTCUSD','C:EURUSD','SPY','X:ETHUSD'];
        for(var i=0;i<defaults.length;i++) await openChart(defaults[i]);
        focusSlot(0);
        console.log('[InvertProfit] Gr√°ficos por defecto cargados');
    }else{
        console.warn('[InvertProfit] No se pudieron cargar precios iniciales');
    }

    // Connect WebSockets for real-time streaming
    connectAllWS();

    // REST fallback poll every 8s (only when WS is down for that market)
    setInterval(pollREST,8000);

    // Refresh snapshots every 60s (catches up any missed data)
    setInterval(function(){
        loadSnapshots().then(function(n){
            if(n){console.log('[Polygon] Snapshot refresh:',n,'actualizados');renderTickerTape();}
        });
    },60000);

    // Refresh candle data for open charts every 45s
    setInterval(async function(){
        for(var i=0;i<4;i++){
            var s=slots[i];if(!s)continue;
            var raw=await getCandles(s.ticker,s.tf.mul,s.tf.span);
            if(raw.length){s.candles=raw;renderSlotCandles(i,raw);}
        }
    },45000);

    console.log('[InvertProfit] Terminal listo ‚úì');
}
document.addEventListener('DOMContentLoaded',init);
})();
</script>
</body>
</html>